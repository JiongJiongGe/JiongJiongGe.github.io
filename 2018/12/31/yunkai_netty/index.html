<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Nettyï¼šèµ°ä¸€èµ°å¾®ä¿¡IMå³ä½¿é€šè®¯ | å®ˆå¾—äº‘å¼€è§æœˆæ˜ | åœ¨ITæµ·æ´‹æ‰“æ»šçš„å°ğŸ³</title>

  
  <meta name="author" content="äº‘å¼€">
  

  
  <meta name="description" content="åœ¨ITæµ·æ´‹æ‰“æ»šçš„å°ğŸ³">
  

  
  
  <meta name="keywords" content="SpringBoot,Netty,NIO">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Nettyï¼šèµ°ä¸€èµ°å¾®ä¿¡IMå³ä½¿é€šè®¯"/>

  <meta property="og:site_name" content="å®ˆå¾—äº‘å¼€è§æœˆæ˜"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="å®ˆå¾—äº‘å¼€è§æœˆæ˜" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">å®ˆå¾—äº‘å¼€è§æœˆæ˜</a>
    </h1>
    <p class="site-description">åœ¨ITæµ·æ´‹æ‰“æ»šçš„å°ğŸ³</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">é¦–é¡µ</a></li>
      
        <li><a href="/about">å…³äº</a></li>
      
        <li><a href="/archives">å½’æ¡£</a></li>
      
        <li><a href="/tags">æ ‡ç­¾</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Nettyï¼šèµ°ä¸€èµ°å¾®ä¿¡IMå³ä½¿é€šè®¯</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/12/31/yunkai_netty/" rel="bookmark">
        <time class="entry-date published" datetime="2018-12-31T10:27:43.000Z">
          2018-12-31
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>çŸ«æƒ…ä¸€ä¸‹ï¼š<br>çœ‹äº†ä¸Šä¸€æ¬¡åšå®¢ï¼Œå‘ç°å·²ç»æ˜¯åŠå¹´å‰äº†ã€‚ç¡®å®å˜æ‡’äº†ä¸€äº›ï¼Œå‘¨æœ«é™¤äº†è§£å†³å…¬å¸é—®é¢˜ï¼ŒåŸºæœ¬ä¸Šä¸æ€ä¹ˆä¼šå¼€ç”µè„‘ï¼Œç¿»ç¿»ä¹¦ï¼Œçœ‹çœ‹ç”µè§†ï¼Œçœ¨çœ¼é—´å‘¨ä¸€åˆåˆ°äº†ã€‚ä¸è¿‡æˆ‘è¿˜æ˜¯å¾ˆåº†å¹¸æœ‰è¿™æ ·çš„æ—¶å…‰ï¼ŒåŠå¹´æ²¡è§äº†ï¼Œç›¸ä¿¡å¤§å®¶æå‡äº†ä¸å°‘ï¼Œäº‘å¼€ä¹Ÿæ²¡æœ‰æ€ æ…¢å“¦ï¼Œç»å†äº†å…¬å¸çš„å…­ä¸€å…«ã€åŒåä¸€ã€åŒåäºŒæ€§èƒ½çš„è€ƒéªŒã€åœ¨ä¹¦ä¸­è·å–åˆ°äº†ä¸æ›¾äº†è§£çš„çŸ¥è¯†ã€å¯¹ç”Ÿæ´»çš„æƒ³æ³•ä¹Ÿæˆç†Ÿäº†ä¸€äº›ã€‚å¥½äº†ï¼Œå°±çŸ«æƒ…åˆ°è¿™å§ï¼Œè®©æˆ‘ä»¬è¿›å…¥è¿™æ¬¡çš„æ­£é¢˜ï¼ŒNettyå­¦ä¹ ã€‚</p>
<h2 id="Nettyæ˜¯è°ï¼Ÿ"><a href="#Nettyæ˜¯è°ï¼Ÿ" class="headerlink" title="Nettyæ˜¯è°ï¼Ÿ"></a>Nettyæ˜¯è°ï¼Ÿ</h2><p>å€ŸåŠ©å®˜æ–¹çš„è¯ï¼šNettyæ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«è¯»å¼€å‘å¯ç»´æŠ¤çš„é«˜æ€§èƒ½åè®®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚<br>åŒæ—¶ï¼ŒNettyæ˜¯ä¸€ä¸ªåŸºäºNIOçš„å®¢æˆ·ç«¯ã€æœåŠ¡æ–­æ¡†æ¶ã€‚</p>
<h2 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h2><p>åœ¨å¦‚ä»Šä¸»æµçš„Rpcæ¡†æ¶ï¼Œå¦‚ï¼šDubboï¼Œå¯æ˜¯æœ‰Nettyçš„èº«å½±å“¦ï¼Œä¸çŸ¥é“å¤§å®¶æ˜¯å¦æœ‰ç•™æ„è¿‡ï¼Œå½“dubboæœåŠ¡ç«¯æœªå¯åŠ¨æ—¶ï¼Œå½“å®¢æˆ·ç«¯å»è¿æ¥/è°ƒç”¨çš„æ—¶å€™ï¼Œåœ¨å‡ºç°çš„é”™è¯¯ä¸­ï¼Œä¼šæœ‰ä¸€äº›Nettyçš„é”™è¯¯ä¿¡æ¯ï¼Œè¿™è¾¹å°±ä¸ç»†è®²äº†ï¼Œå¦‚æœæœ‰å…´è¶£å¯ä»¥å»å®è·µä¸€ä¸‹ã€‚<br>é™¤äº†dubboï¼Œåœ¨Redisåº•å±‚ä¸­ï¼ŒNettyä¹Ÿæ˜¯å…¶ä¸­ä¸€ä¸ªè§’è‰²å™¢ã€‚è¿™è¾¹äº‘å¼€å°±åˆ—äº†è¿™ä¸¤ä¸ªä¾‹å­ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥æœä¸‹èµ„æ–™ï¼Œçœ‹çœ‹Nettyçš„å…¶ä»–å½±å­ã€‚<br>etcâ€¦</p>
<h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>JDK 1.8.0_131ã€MAVEN apache-maven-3.5.0</p>
<h3 id="æŠ€æœ¯æ ˆ"><a href="#æŠ€æœ¯æ ˆ" class="headerlink" title="æŠ€æœ¯æ ˆ"></a>æŠ€æœ¯æ ˆ</h3><p>SpringBootã€Mybatisã€Zookeeper</p>
<h3 id="å¼€å‘å·¥å…·"><a href="#å¼€å‘å·¥å…·" class="headerlink" title="å¼€å‘å·¥å…·"></a>å¼€å‘å·¥å…·</h3><p>IntelliJ IDEA 2(å¼€å‘å·¥å…·å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½è€Œå®š)</p>
<h3 id="å®è·µè¿‡ç¨‹"><a href="#å®è·µè¿‡ç¨‹" class="headerlink" title="å®è·µè¿‡ç¨‹"></a>å®è·µè¿‡ç¨‹</h3><p>å®è·µçš„è¯ï¼Œæˆ‘å°†é€šè¿‡æœåŠ¡ç«¯å¯åŠ¨ã€å®¢æˆ·ç«¯å¯åŠ¨ã€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡ã€ç»´æŠ¤/æ–­å¼€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡è¿™å››ä¸ªæ–¹é¢ä»‹ç»æˆ‘å¯¹Nettyçš„ç®€å•å®è·µã€ç†è§£ï¼Œå¦‚æœå¤§å®¶è§‰å¾—ç›´æ¥é˜…è¯»ä»£ç æœ‰äº›ä¸é€‚ï¼Œå¤§å®¶å¯ä»¥ç›´æ¥æ‹‰åˆ°æœ€åçŸ¥è¯†ç‚¹ä»‹ç»ï¼Œé¦–å…ˆå¼€å§‹é˜…è¯»ï¼Œç„¶åå†å›è¿‡å¤´æ¥çœ‹ä»£ç çš„å®ç°ã€‚</p>
<h4 id="æœåŠ¡ç«¯å¯åŠ¨"><a href="#æœåŠ¡ç«¯å¯åŠ¨" class="headerlink" title="æœåŠ¡ç«¯å¯åŠ¨"></a>æœåŠ¡ç«¯å¯åŠ¨</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class NettyServerStartRunner implements CommandLineRunner &#123;</span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(NettyServerStartRunner.class);</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private ZKServiceRegistry zkServiceRegistry;</span><br><span class="line">    @Override</span><br><span class="line">    public void run(String... args) throws Exception &#123;</span><br><span class="line">        /**</span><br><span class="line">         * æ¥æ”¶æ–°çš„å®¢æˆ·ç«¯é“¾æ¥çº¿ç¨‹ç»„</span><br><span class="line">         */</span><br><span class="line">        NioEventLoopGroup boss = new NioEventLoopGroup();</span><br><span class="line">        /**</span><br><span class="line">         * å¤„ç†æ¯æ¡é“¾æ¥å†™å…¥çš„æ•°æ®çº¿ç¨‹ç»„</span><br><span class="line">         */</span><br><span class="line">        NioEventLoopGroup worker = new NioEventLoopGroup();</span><br><span class="line">        /**</span><br><span class="line">         * å¼•å¯¼æœåŠ¡ç«¯å¯åŠ¨å·¥ä½œç±»</span><br><span class="line">         */</span><br><span class="line">        ServerBootstrap serverBootstrap = new ServerBootstrap();</span><br><span class="line">        serverBootstrap</span><br><span class="line">                //.group é…ç½®çº¿ç¨‹ç»„</span><br><span class="line">                .group(boss, worker)</span><br><span class="line">                //.channel æŒ‡å®šæœåŠ¡ç«¯çš„IOæ¨¡å‹ï¼ŒNioServerSocketChannelä¸ºNIOæ¨¡å‹</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                //.childHandler å®šä¹‰åç»­æ¯æ¡é“¾æ¥çš„æ•°æ®è¯»å†™ï¼ŒNioSocketChannelåŒç†å®šä¹‰NIOæ¨¡å‹</span><br><span class="line">                .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    protected void initChannel(NioSocketChannel ch) throws Exception &#123;</span><br><span class="line">                        ch.pipeline().addLast(new IMIdleStateHandler());</span><br><span class="line">                        ch.pipeline().addLast(new Spliter());</span><br><span class="line">                        ch.pipeline().addLast(PacketCodecHandler.INSTANCE);</span><br><span class="line">                        ch.pipeline().addLast(new CreateGroupHandler());</span><br><span class="line">                        ch.pipeline().addLast(IMHandler.INSTANCE);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                //æŒ‡å®šæœåŠ¡ç«¯å¯åŠ¨è¿‡ç¨‹ä¸­çš„ä¸€äº›é€»è¾‘</span><br><span class="line">                .handler(new ChannelInitializer&lt;NioServerSocketChannel&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    protected void initChannel(NioServerSocketChannel serverCh) throws Exception &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                //.childOptionå¼€å¯tcpåº•å±‚ç›¸å…³çš„å±æ€§ï¼Œso_keepAlive true è¡¨ç¤ºåº•å±‚å¼€å¯å¿ƒè·³åè®®</span><br><span class="line">                .childOption(ChannelOption.SO_KEEPALIVE, true)</span><br><span class="line">                //.option æœåŠ¡ç«¯è®¾ç½®å±æ€§ï¼Œso_backlogè¡¨ç¤ºç³»ç»Ÿç”¨äºä¸´æ—¶å­˜æ”¾å·²å®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„è¯·æ±‚é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼Œå¦‚æœè¿æ¥å»ºç«‹é¢‘ç¹ï¼Œå¯ä»¥æ‰©å¤§è¯¥å€¼ã€‚</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, 1024)</span><br><span class="line">                .option(ChannelOption.TCP_NODELAY, true);</span><br><span class="line"></span><br><span class="line">        //.addListener ç»™è¿”å›ç»“æœChannelFutureç»‘å®šç›‘å¬å™¨ï¼Œç”¨æˆ·åˆ¤æ–­ç«¯å£æ˜¯å¦ç»‘å®šæˆåŠŸ</span><br><span class="line">        serverBootstrap.bind(&quot;127.0.0.1&quot;, 8000).addListener(new GenericFutureListener&lt;Future&lt;? super Void&gt;&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void operationComplete(Future&lt;? super Void&gt; future) throws Exception &#123;</span><br><span class="line">                if (future.isSuccess()) &#123;</span><br><span class="line">                    logger.info(&quot;ç«¯å£ç»‘å®šæˆåŠŸ&quot;);</span><br><span class="line">                    if (zkServiceRegistry != null) &#123;</span><br><span class="line">                        zkServiceRegistry.register(&quot;127.0.0.1:8000&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //æŸ¥çœ‹é”™è¯¯æ•°æ®</span><br><span class="line">                    logger.error(future.cause().getMessage());</span><br><span class="line">                    logger.info(&quot;ç«¯å£ç»‘å®šå¤±è´¥&quot;);</span><br><span class="line">                    //å¤±è´¥åå¯é‡æ–°ç»‘å®š</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NettyServerStartRunnerç±»ï¼Œå€ŸåŠ©äº†SpringBootçš„CommandLineRunneræ¥å£ï¼Œä½¿å¾—åœ¨é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¯åŠ¨NettyæœåŠ¡ç«¯ã€‚<br>ç±»å†…å…ƒç´ è¯´æ˜ï¼š<br>1ã€ç”±äºNettyæ˜¯åŸºäºNIOçš„æ¡†æ¶ï¼Œå…¶çº¿ç¨‹ç»„çš„å®ç°åŸç†ä¹Ÿä¸NIOç±»ä¼¼ï¼Œæ•…åˆ›å»ºäº†bosså’Œworkerä¸¤ä¸ªçº¿ç¨‹ç»„ï¼Œbossçº¿ç¨‹ç»„ç”¨æˆ·æ¥å—æ–°çš„å®¢æˆ·ç«¯é“¾æ¥,workerçº¿ç¨‹ç»„åˆ™å¤„ç†æ¯æ¡å®¢æˆ·ç«¯é“¾æ¥çš„å†™å…¥ã€‚<br>2ã€serverBootstrap å¼•å¯¼æœåŠ¡ç«¯çš„å¯åŠ¨ç±»ï¼Œåœ¨serverBootstrapä¼šé…ç½®çº¿ç¨‹ç»„ã€æœåŠ¡ç«¯çš„IOç±»å‹ä»¥åŠå¼€å¯ç›¸å…³çš„å±æ€§ç­‰ï¼Œå¤§å®¶å¯ä»¥æŸ¥çœ‹ä»£ç ä¸­çš„æ³¨é‡Šï¼Œç®€å•äº†è§£ä¸‹æ¯ä¸ªå…ƒç´ çš„ä½œç”¨ã€‚è¿™é‡Œç‰¹åˆ«æ³¨æ„ä¸¤ä¸ªç‚¹ï¼š(1)ã€childHandler()å†…å…ƒç´ å®šä¹‰äº†ä¹‹åçš„æ¯æ¡å®¢æˆ·ç«¯é“¾æ¥è¯»å†™çš„è¿‡ç¨‹ï¼Œå…·ä½“çš„ä¼šåœ¨(å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡)é‡Œé¢è¯¦ç»†ä»‹ç»ï¼›(2)ã€bindæ–¹æ³•åˆ™ä¸ºæœåŠ¡ç«¯ç»‘å®šå¯¹åº”çš„ipåœ°å€å’Œç«¯å£ï¼Œå¹¶å¢åŠ äº†ä¸ªlistener(ç›‘å¬),å¦‚æœä¸ip+ç«¯å£ç»‘å®šæˆåŠŸåï¼Œå°†æ­¤æœåŠ¡ç«¯æœåŠ¡æ³¨å…¥åˆ°zkä¸­ã€‚</p>
<h4 id="å®¢æˆ·ç«¯å¯åŠ¨"><a href="#å®¢æˆ·ç«¯å¯åŠ¨" class="headerlink" title="å®¢æˆ·ç«¯å¯åŠ¨"></a>å®¢æˆ·ç«¯å¯åŠ¨</h4><h5 id="NettyClientStartRunnerç±»"><a href="#NettyClientStartRunnerç±»" class="headerlink" title="NettyClientStartRunnerç±»"></a>NettyClientStartRunnerç±»</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class NettyClientStartRunner implements CommandLineRunner&#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(NettyClientStartRunner.class);</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ZKServiceDiscovery zkServiceDiscovery;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(String... args) throws Exception &#123;</span><br><span class="line">        ZKServiceDiscovery.zkServiceDiscovery = zkServiceDiscovery;</span><br><span class="line">        zkServiceDiscovery.connectServer();</span><br><span class="line">        zkServiceDiscovery.getNode();</span><br><span class="line">        String serverAddress = zkServiceDiscovery.discover();</span><br><span class="line">        if (!StringUtils.isEmpty(serverAddress)) &#123;</span><br><span class="line">            ZKConstant.ZK_CURRENT_SERVER_NODE = serverAddress;</span><br><span class="line">            String[] addressArr = serverAddress.split(&quot;:&quot;);</span><br><span class="line">            if (addressArr != null &amp;&amp; addressArr.length &gt; 0) &#123;</span><br><span class="line">                ClientConnectUtil.connect(addressArr[0], Integer.parseInt(addressArr[1]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NettyClientStartRunnerç±»ï¼ŒåŒæ ·å€ŸåŠ©äº†SpringBootçš„CommandLineRunneræ¥å£ï¼Œä½¿å¾—é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå°±è®©å®¢æˆ·ç«¯å°è¯•å»é“¾æ¥æœåŠ¡ç«¯ã€‚<br>è¯´æ˜ï¼š<br>æ­¤å¤„æŠŠNettyå®¢æˆ·ç«¯é“¾æ¥æœåŠ¡ç«¯çš„é€»è¾‘æŠ½ç¦»æˆClientConnectUtilçš„å·¥å…·æ–¹æ³•çš„åŸå› æ˜¯ï¼Œäº‘å¼€æƒ³æ¨¡æ‹Ÿå¤šä¸ªæœåŠ¡ç«¯æä¾›æœåŠ¡ï¼Œå½“å®¢æˆ·ç«¯å·²é“¾æ¥çš„æœåŠ¡ç«¯å› ä¸ºæŸäº›åŸå› ï¼Œä¾‹å¦‚æ­¤æœåŠ¡ç«¯è¢«å…³é—­äº†ï¼Œå®¢æˆ·ç«¯èƒ½å¤Ÿé‡æ–°é“¾æ¥æ–°çš„æœåŠ¡æä¾›è€…ï¼Œä»è€Œä¸å½±å“å®¢æœç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„é€šè®¯ã€‚ä¸Šè¿°ClientConnectUtil.connectæ–¹æ³•åˆ™æ˜¯ä»zkä¸­æœåŠ¡ç«¯åˆ—è¡¨ä¸­éšæœºæ‹¿å–ä¸€ä¸ªæœåŠ¡ç«¯ä¿¡æ¯ï¼Œå°è¯•å»é“¾æ¥ã€‚</p>
<h5 id="ClientConnectUtilç±»"><a href="#ClientConnectUtilç±»" class="headerlink" title="ClientConnectUtilç±»"></a>ClientConnectUtilç±»</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">public class ClientConnectUtil &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(ClientConnectUtil.class);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è½®è¯¢ç™»å½•ï¼Œ5sä¸€æ¬¡</span><br><span class="line">     */</span><br><span class="line">    private static final int TIME_LOGIN = 5;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯</span><br><span class="line">     */</span><br><span class="line">    public static Channel connect(String host, int port) &#123;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * çº¿ç¨‹ç»„(çº¿ç¨‹æ¨¡å‹)</span><br><span class="line">         */</span><br><span class="line">        NioEventLoopGroup workerGroup = new NioEventLoopGroup();</span><br><span class="line">        /**</span><br><span class="line">         * å®¢æˆ·ç«¯å¯åŠ¨ç±»ï¼Œè´Ÿè´£å¯åŠ¨å®¢æˆ·ç«¯ä»¥åŠè¿æ¥æœåŠ¡ç«¯</span><br><span class="line">         */</span><br><span class="line">        Bootstrap bootstrap = new Bootstrap();</span><br><span class="line">        bootstrap</span><br><span class="line">                //.group é…ç½®çº¿ç¨‹ç»„</span><br><span class="line">                .group(workerGroup)</span><br><span class="line">                //.channel æŒ‡å®šIOæ¨¡å‹ NioSocketChannelä¸ºNIOæ¨¡å‹</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                //.handler å®šä¹‰è¿æ¥çš„ä¸šåŠ¡å¤„ç†é€»è¾‘</span><br><span class="line">                .handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    protected void initChannel(SocketChannel ch) throws Exception &#123;</span><br><span class="line">                        //ch.pipeline()è¿”å›å’Œæ­¤æ¡è¿æ¥ç›¸å…³çš„è´£ä»»é“¾</span><br><span class="line">                        ch.pipeline().addLast(new IMIdleStateHandler());</span><br><span class="line">                        ch.pipeline().addLast(new Spliter());</span><br><span class="line">                        ch.pipeline().addLast(PacketCodecHandler.INSTANCE);</span><br><span class="line">                        ch.pipeline().addLast(LoginAdapter.INSTANCE);</span><br><span class="line">                        ch.pipeline().addLast(LoginResponseHandler.INSTANCE);</span><br><span class="line">                        ch.pipeline().addLast(new ConfigRequestHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                //.optionè®¾ç½®tcpåº•å±‚ç›¸å…³å±æ€§ï¼ŒCONNECT_TIMEOUT_MILLISè¡¨ç¤ºè¿æ¥æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´åˆ™è¿ä¸ä¸Š</span><br><span class="line">                .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000)</span><br><span class="line">                .option(ChannelOption.TCP_NODELAY, true);</span><br><span class="line">        return bootstrap.connect(host, port)</span><br><span class="line">                .addListener(new ChannelFutureListener() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void operationComplete(ChannelFuture future) throws Exception &#123;</span><br><span class="line">                        if (future.isSuccess()) &#123;</span><br><span class="line">                            logger.info(&quot;è¿æ¥æˆåŠŸ&quot;);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            logger.error(future.cause().getMessage());</span><br><span class="line">                            logger.info(&quot;è¿æ¥å¤±è´¥&quot;);</span><br><span class="line">                            future.channel().eventLoop().schedule(new Runnable() &#123;</span><br><span class="line">                                @Override</span><br><span class="line">                                public void run() &#123;</span><br><span class="line">                                    String serverAddress;</span><br><span class="line">                                    //ä¼˜å…ˆéå†å­˜åœ¨çš„èŠ‚ç‚¹</span><br><span class="line">                                    Set&lt;String&gt; dataAddressList =  ZKServiceDiscovery.dataAddressList;</span><br><span class="line">                                    if (!dataAddressList.isEmpty()) &#123;</span><br><span class="line">                                        serverAddress = provideServerAddress(dataAddressList);</span><br><span class="line">                                    &#125; else &#123;</span><br><span class="line">                                        //éå†ä¸å¯ä½¿ç”¨çš„ç‚¹ï¼Œè¯´ä¸å®šå°±å¼€å¯äº†ã€‚</span><br><span class="line">                                        Set&lt;String&gt; notUserAddressList = ZKServiceDiscovery.notUserAddressList;</span><br><span class="line">                                        serverAddress = provideServerAddress(notUserAddressList);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    ZKConstant.ZK_CURRENT_SERVER_NODE = serverAddress;</span><br><span class="line">                                    logger.info(&quot;serverAddress = &#123;&#125;&quot;, serverAddress);</span><br><span class="line">                                    if (!StringUtils.isEmpty(serverAddress)) &#123;</span><br><span class="line">                                        String[] addressArr = serverAddress.split(&quot;:&quot;);</span><br><span class="line">                                        if (addressArr != null &amp;&amp; addressArr.length &gt; 0) &#123;</span><br><span class="line">                                            connect(addressArr[0], Integer.parseInt(addressArr[1]));</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;, TIME_LOGIN, TimeUnit.SECONDS);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).channel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * éšæœºæä¾›æœåŠ¡è€…çš„åœ°å€</span><br><span class="line">     *</span><br><span class="line">     * @param addressList</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static String provideServerAddress(Set&lt;String&gt; addressList) &#123;</span><br><span class="line">        List&lt;String&gt; list = new ArrayList&lt;&gt;(addressList);</span><br><span class="line">        String serverAddress = list.get(ThreadLocalRandom.current().nextInt(addressList.size()));</span><br><span class="line">        logger.info(&quot;éšæœº serverAddress = &#123;&#125;&quot;, serverAddress);</span><br><span class="line">        return serverAddress;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•ä»‹ç»ï¼š<br>1ã€connect()æ–¹æ³•ï¼Œåœ¨connect()æ–¹æ³•ä¸­ï¼Œå£°æ˜äº†workerGroupçº¿ç¨‹ç»„ä»¥åŠbootstrapå®¢æˆ·ç«¯å¯åŠ¨ç±»ï¼Œåœ¨bootstrapé…ç½®workerGroupçº¿ç¨‹ç»„ã€IOæ¨¡å‹ã€ä¸€äº›åº•å±‚çš„tcpç›¸å…³å±æ€§ï¼Œè¿™é‡Œä¹Ÿä¸å…·ä½“å±•å¼€ä»‹ç»äº†ï¼Œå¤§å®¶å¯ä»¥ç»“åˆä»£ç çš„æ³¨é‡Šç†è§£ã€‚ä¸»è¦ä»‹ç»ä¸‹bootstrapçš„handler()å’Œconnect()æ–¹æ³•ï¼Œhandler()å†…å…ƒç´ å®šä¹‰äº†ä¹‹åå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·çš„æ¶ˆæ¯åŠ¨ä½œä»¥åŠæ¥å—æœåŠ¡ç«¯å›ä¼ çš„æ¶ˆæ¯å¤„ç†åŠ¨ä½œï¼Œå…·ä½“çš„handlerä¼šåœ¨(å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡)é‡Œé¢è¯¦ç»†ä»‹ç»ã€‚bootstrapçš„connect()æ–¹æ³•åˆ™æ˜¯å®¢æˆ·ç«¯ä»zkä¸­è·å–åˆ°æœåŠ¡ç«¯åœ°å€ï¼Œç„¶åå°è¯•å»è¿æ¥æœåŠ¡ç«¯ï¼Œå¹¶å¢åŠ listenerç›‘å¬ï¼Œå¦‚æœå‘ç°æœªè¿æ¥ä¸Šï¼Œä¼šä»zkä¸­éšæœºå†è·å–æ–°çš„æœåŠ¡ç«¯åœ°å€ï¼Œå†å°è¯•è¿›è¡Œè¿æ¥ã€‚<br>2ã€provideServerAddress()æ–¹æ³•åˆ™æ˜¯æŠ½å‡ºæ¥ï¼Œç”¨æˆ·å®¢æˆ·ç«¯éšæœºä»æœåŠ¡ç«¯è·å–å¯ç”¨çš„åœ°å€ã€‚</p>
<h4 id="å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡"><a href="#å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡" class="headerlink" title="å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡"></a>å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡</h4><p>è®²å®Œäº†æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯å„è‡ªçš„å¯åŠ¨ï¼Œæ¥ä¸‹æ¥å®¢æˆ·ç«¯ä¸æœåŠ¡å•çš„é€šä¿¡åˆ™æ˜¯é‡å¤´ã€‚é€šä¿¡æ—¶ï¼Œéœ€è¦æ³¨æ„çš„ç‚¹æœ‰å¾ˆå¤šï¼Œå°†ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å®Œæˆå¯¹é€šä¿¡çš„ç†è§£ï¼š<br>1ã€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡åè®®ç¼–è§£ç ;<br>2ã€é€šä¿¡ä¿¡æ¯çš„æ‹†åŒ…ç²˜åŒ…å¤„ç†ï¼›<br>3ã€è§’è‰²æ ¡éªŒ(ä¾‹å¦‚æ—¥å¸¸çš„ç”¨æˆ·çš„ç™»å½•);<br>4ã€æ ¡éªŒé€šè¿‡å®Œæˆè‡ªå·±æ‰€éœ€çš„ä¸šåŠ¡é€šä¿¡é€»è¾‘ã€‚<br>é‚£ä¹ˆæˆ‘ä»¬å°±å¼€å§‹ä¸€æ­¥æ­¥å¾€ä¸‹èµ°å§</p>
<h5 id="ä¸€ã€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡åè®®ç¼–è§£ç "><a href="#ä¸€ã€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡åè®®ç¼–è§£ç " class="headerlink" title="ä¸€ã€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡åè®®ç¼–è§£ç "></a>ä¸€ã€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡åè®®ç¼–è§£ç </h5><p>æ‰€è°“çš„é€šä¿¡åè®®ï¼ŒæŒ‡çš„æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯äº‹å…ˆå®šä¹‰å¥½è§„åˆ™ï¼Œä½¿å¾—æ•°æ®åŒ…æ¯ä¸€æ®µå­—èŠ‚åˆ†è¡¨ä»£è¡¨ä»€ä¹ˆå«ä¹‰çš„è§„åˆ™ã€‚<br>è§„åˆ™è®¾ç½®å¦‚å›¾æ‰€ç¤ºï¼š<br><img src="http://yunkai-wjd.oss-cn-beijing.aliyuncs.com/blog_netty_xieyi.png?Expires=1546246260&amp;OSSAccessKeyId=TMP.AQHv0OmkU7XCzkD8oC_XF35Ox5UTzZriu9ergiU9rBXOVze9-GW8UdXVSr0iMC4CFQDPbpufEaT4VrRcy-y92BO-QNwmzAIVALrOeUq8BgoDIt0yANMZoIHuc_78&amp;Signature=p%2BXaO4k6C6K4hr8komr%2FIgcvcNY%3D" alt="é€šä¿¡åè®®"><br>é­”æ•°ï¼šç”¨äºåŒºåˆ«æ­¤æ•°æ®åŒ…æ˜¯å¦æ˜¯å¦ç¬¦åˆè‡ªå®šä¹‰çš„è§„èŒƒï¼Œå¦‚æœä¸ç¬¦åˆï¼Œå¯ç›´æ¥ä¸¢å¼ƒæ­¤æ•°æ®åŒ…;<br>ç‰ˆæœ¬å·ï¼šé¢„ç•™å­—æ®µï¼Œåè®®å‡çº§çš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ç”¨ä¸åˆ°çš„;<br>åºåˆ—åŒ–ç®—æ³•ï¼šåºåˆ—åŒ–ç®—æ³•ä¼šè§„å®šJavaå¯¹è±¡æ˜¯å¦‚ä½•è½¬ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼ŒåŒæ—¶å¦‚ä½•æŠŠäºŒè¿›åˆ¶æ•°æ®è½¬æ¢æˆJavaå¯¹è±¡çš„;<br>æŒ‡ä»¤ï¼šåˆ™ä¼šè¡¨ç¤ºè¯¥ç”¨æ€æ ·çš„é€»è¾‘å»å¤„ç†è¿™ä¸ªæ•°æ®åŒ…ä¿¡æ¯;<br>æ•°æ®é•¿åº¦ï¼šåˆ™è¡¨ç¤ºæ­¤æ•°æ®åŒ…çš„é•¿åº¦;<br>æ•°æ®ï¼šæ•°æ®åŒ…çš„æ•°æ®ã€‚</p>
<p>EncodeUtilç±»æ–¹æ³•åˆ™æ˜¯æŒ‰ç…§ä¸Šé¢çš„é€šä¿¡åè®®ï¼Œæä¾›å¯¹æ•°æ®ç¼–ç /è§£ç çš„æ–¹æ³•ã€‚è¿™é‡Œçš„packetMapä»¥æœåŠ¡ç«¯ä¸ºä¾‹ï¼Œå®¢æˆ·ç«¯åˆ™æœ‰å¯¹åº”çš„ä¸€ä»½æŒ‡ä»¤å¯¹åº”å…³ç³»ï¼Œåœ¨è§£ç çš„æ—¶å€™ä¼šå»åˆ¤æ–­æ­¤æ•°æ®çš„æŒ‡ä»¤æ˜¯å¦æå‰å£°æ˜ï¼ŒéªŒè¯é€šè¿‡åæ‰ä¼šå°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢æˆJavaå¯¹è±¡ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">public class EncodeUtil &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(EncodeUtil.class);</span><br><span class="line">    public static final int MAGIC_NUMBER = 0x12345678;</span><br><span class="line">    private static final Map&lt;Byte, Class&lt;? extends Packet&gt;&gt; packetMap;</span><br><span class="line">    private static final Map&lt;Byte, SerializerInterface&gt; serializerMap;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        //è¯·æ±‚pack</span><br><span class="line">        packetMap = new HashMap&lt;&gt;();</span><br><span class="line">        packetMap.put(CommandInterface.LOGIN_REQUEST, LoginRequestPacket.class);</span><br><span class="line">        packetMap.put(CommandInterface.HEART_REQUEST, HeartRequestPacket.class);</span><br><span class="line">        packetMap.put(CommandInterface.CLIENT_STOP_REQUEST, ClientStopRequestPacket.class);</span><br><span class="line"></span><br><span class="line">        serializerMap = new HashMap&lt;&gt;();</span><br><span class="line">        SerializerInterface serializerInterface = new JSONSerializerImpl();</span><br><span class="line">        serializerMap.put(SerializerAlgorithmInterface.JSON_ALGORITHM, serializerInterface);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * ç¼–ç </span><br><span class="line">     *</span><br><span class="line">     * @param byteBuf</span><br><span class="line">     * @param packet</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static ByteBuf encode(ByteBuf byteBuf, Packet packet) &#123;</span><br><span class="line">        // 2. åºåˆ—åŒ– Java å¯¹è±¡ï¼Œè¿™ç§æ–¹å¼å¾ˆç‹¬ç‰¹ SerializerInterface.DEFAULT</span><br><span class="line">        byte[] bytes = SerializerInterface.DEFAULT.serialize(packet);</span><br><span class="line">        // 3. å®é™…ç¼–ç è¿‡ç¨‹</span><br><span class="line">        byteBuf.writeInt(MAGIC_NUMBER);</span><br><span class="line">        byteBuf.writeByte(packet.getX_version());</span><br><span class="line">        byteBuf.writeByte(SerializerInterface.DEFAULT.getSerializerAlgorithm());</span><br><span class="line">        byteBuf.writeByte(packet.getCommand());</span><br><span class="line">        byteBuf.writeInt(bytes.length);</span><br><span class="line">        byteBuf.writeBytes(bytes);</span><br><span class="line"></span><br><span class="line">        return byteBuf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è§£ç </span><br><span class="line">     *</span><br><span class="line">     * @param byteBuf</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static Packet decode(ByteBuf byteBuf) &#123;</span><br><span class="line">        //è·³è¿‡éƒ¨åˆ†å¦‚æœéœ€è¦éªŒè¯ï¼Œå¯è‡ªè¡Œå¤„ç†çš„</span><br><span class="line">        //è·³è¿‡é­”æ•°éªŒè¯ï¼Œ4å­—èŠ‚</span><br><span class="line">        byteBuf.skipBytes(4);</span><br><span class="line">        //è·³è¿‡ç‰ˆæœ¬å·éªŒè¯ï¼Œ1å­èŠ‚</span><br><span class="line">        byteBuf.skipBytes(1);</span><br><span class="line">        //è·å–åºåˆ—åŒ–ç®—æ³•æ ‡è¯†</span><br><span class="line">        byte serializeAlgorithm = byteBuf.readByte();</span><br><span class="line">        // æŒ‡ä»¤</span><br><span class="line">        byte command = byteBuf.readByte();</span><br><span class="line">        //æ•°æ®é•¿åº¦</span><br><span class="line">        int length = byteBuf.readInt();</span><br><span class="line">        //æ•°æ®</span><br><span class="line">        byte[] bytes = new byte[length];</span><br><span class="line">        byteBuf.readBytes(bytes);</span><br><span class="line">        //éªŒè¯æŒ‡ä»¤å’Œåºåˆ—åŒ–ç®—æ³•</span><br><span class="line">        Class&lt;? extends Packet&gt; requestCommond = getRequestType(command);</span><br><span class="line">        SerializerInterface serializerInterface = getSerializer(serializeAlgorithm);</span><br><span class="line">        if (requestCommond != null &amp;&amp; serializerInterface != null) &#123;</span><br><span class="line">            return SerializerInterface.DEFAULT.deserialize(requestCommond, bytes);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            logger.info(&quot;æŒ‡ä»¤æˆ–è€…åºåˆ—åŒ–ç®—æ³•ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ•°æ®ï¼&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *</span><br><span class="line">     * @param serializeAlgorithm</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private static SerializerInterface getSerializer(byte serializeAlgorithm) &#123;</span><br><span class="line">        return serializerMap.get(serializeAlgorithm);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *</span><br><span class="line">     * @param command</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private static Class&lt;? extends Packet&gt; getRequestType(byte command) &#123;</span><br><span class="line">        return packetMap.get(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="äºŒã€é€šä¿¡ä¿¡æ¯çš„æ‹†åŒ…ç²˜åŒ…å¤„ç†"><a href="#äºŒã€é€šä¿¡ä¿¡æ¯çš„æ‹†åŒ…ç²˜åŒ…å¤„ç†" class="headerlink" title="äºŒã€é€šä¿¡ä¿¡æ¯çš„æ‹†åŒ…ç²˜åŒ…å¤„ç†"></a>äºŒã€é€šä¿¡ä¿¡æ¯çš„æ‹†åŒ…ç²˜åŒ…å¤„ç†</h5><p>æ‹†åŒ…ã€ç²˜åŒ…å…¶å®æ˜¯ç›¸å¯¹äºç²˜åŒ…ã€åŠåŒ…ç°è±¡çš„å¤„ç†ï¼Œé‚£ä¸ºä»€ä¹ˆä¼šå‡ºç°ç²˜åŒ…ã€åŠåŒ…ç°è±¡å‘¢ï¼Œè™½ç„¶æˆ‘ä»¬ä½¿ç”¨äº†Nettyå»å¤„ç†ï¼Œä½†æ˜¯å¯¹äºæ“ä½œç³»ç»Ÿæ¥è®²ï¼Œåº•å±‚åªè®¤TCPåè®®ï¼Œå®¢æˆ·ç«¯åœ¨Nettyåº”ç”¨å±‚æŒ‰ç…§ByteBufä¸ºå•ä½å‘é€æ•°æ®ï¼Œä½†åˆ°äº†æ“ä½œç³»ç»Ÿåº•å±‚åä»ç„¶æ˜¯ä»¥å­—èŠ‚æµå‘é€æ•°æ®ï¼Œæ•°æ®åˆ°äº†æœåŠ¡ç«¯ä¹ŸæŒ‰ç…§å­—èŠ‚æµçš„æ–¹å¼è¯»å…¥ï¼Œæ•°æ®åˆ°äº†Nettyåº”ç”¨å±‚é‡æ–°å†æ‹¼è£…æˆByteBufï¼Œæ­¤æ—¶æœåŠ¡ç«¯æ¥æ”¶çš„ByteBufå¯èƒ½ä¸å®¢æˆ·ç«¯å‘å‡ºçš„ByteBufæ˜¯ä¸å¯¹ç­‰ï¼Œä»è€Œå‡ºç°äº†ç²˜åŒ…å’ŒåŠåŒ…çš„ç°è±¡ã€‚<br>æ³¨ï¼šNettyåœ¨æ•°æ®ä¼ è¾“ä¸­æ˜¯ä»¥ByteBufä¸ºå•ä½è¿›è¡Œå‘é€å’Œæ¥æ”¶çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class Spliter extends LengthFieldBasedFrameDecoder&#123;</span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(Spliter.class);</span><br><span class="line">    /**</span><br><span class="line">     * é•¿åº¦åŸŸåç§»é‡</span><br><span class="line">     */</span><br><span class="line">    private static final int LENGTH_FIELD_OFFSET = 7;</span><br><span class="line">    /**</span><br><span class="line">     * é•¿åº¦åŸŸé•¿åº¦</span><br><span class="line">     */</span><br><span class="line">    private static final int LENGTH_FIELD_LENGTH = 4;</span><br><span class="line">    public Spliter() &#123;</span><br><span class="line">        super(Integer.MAX_VALUE, LENGTH_FIELD_OFFSET, LENGTH_FIELD_LENGTH);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    protected Object decode(ChannelHandlerContext ctx, ByteBuf in) throws Exception &#123;</span><br><span class="line">        //å±è”½éæ³•æ¶ˆæ¯ï¼Œåˆ¤æ–­é­”æ•°</span><br><span class="line">        if (in.getInt(in.readerIndex()) != EncodeUtil.MAGIC_NUMBER) &#123;</span><br><span class="line">            ctx.channel().close();</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        return super.decode(ctx, in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spliterç±»å°±å¯ä»¥ä½œä¸ºæˆ‘ä»¬çš„æ‹†åŒ…å™¨ï¼Œç»§æ‰¿äº†LengthFieldBasedFrameDecoderç±»ï¼ŒLengthFieldBasedFrameDecoderç±»æ˜¯åŸºäºé•¿åº¦åŸŸæ‹†åŒ…å™¨ï¼Œå¯æ ¹æ®è‡ªå®šä¹‰åè®®ä¸­çš„è§„åˆ™é•¿åº¦è¿›è¡Œå¤„ç†ï¼Œä¾‹å¦‚ç±»ä¸­çš„é•¿åº¦åŸŸåç§»é‡å’Œé•¿åº¦åŸŸé•¿åº¦éƒ½æ˜¯åŸºäºæˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„è§„åˆ™ï¼Œ7=4+1+1+ï¼Œè€Œ4ï¼Œåˆ™è¡¨ç¤ºä¸ºæ•°æ®çš„é•¿åº¦ã€‚åŒæ—¶ï¼Œé‡å†™äº†decode()æ–¹æ³•ï¼Œåœ¨å®Œæˆæ‹†åŒ…åï¼Œä¼šå»æ ¡éªŒæ•°æ®åŒ…å‰4ä¸ªå­—èŠ‚ï¼Œåˆ¤æ–­æ˜¯å¦ç¬¦åˆé­”æ•°ã€‚</p>
<h5 id="ä¸‰ã€è§’è‰²æ ¡éªŒ"><a href="#ä¸‰ã€è§’è‰²æ ¡éªŒ" class="headerlink" title="ä¸‰ã€è§’è‰²æ ¡éªŒ"></a>ä¸‰ã€è§’è‰²æ ¡éªŒ</h5><p>ä»‹ç»äº†å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡åè®®ç¼–è§£ç å’Œé€šä¿¡ä¿¡æ¯çš„æ‹†åŒ…ç²˜åŒ…å¤„ç†ï¼Œå¤§å®¶åº”è¯¥è¿˜æœ‰ä¸ªç–‘æƒ‘ï¼Œåœ¨ç¼–è§£ç ä¸­åªæ˜¯ä»‹ç»äº†ç¼–è§£ç çš„æ–¹æ³•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å…·ä½“è®²åˆ°å¦‚ä½•å»ä½¿ç”¨ï¼Œåœ¨è§’è‰²æ ¡éªŒå‰ï¼Œæˆ‘å…ˆä»‹ç»ä¸‹ç¼–è§£ç çš„ä½¿ç”¨ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@ChannelHandler.Sharable</span><br><span class="line">public class PacketCodecHandler extends MessageToMessageCodec&lt;ByteBuf, Packet&gt; &#123;</span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(PacketCodecHandler.class);</span><br><span class="line">    public static final PacketCodecHandler INSTANCE = new PacketCodecHandler();</span><br><span class="line">    /**</span><br><span class="line">     * åŠ å¯†</span><br><span class="line">     *</span><br><span class="line">     * @param channelHandlerContext</span><br><span class="line">     * @param packet</span><br><span class="line">     * @param list</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void encode(ChannelHandlerContext channelHandlerContext, Packet packet, List&lt;Object&gt; list) throws Exception &#123;</span><br><span class="line">        ByteBuf buf = channelHandlerContext.alloc().buffer();</span><br><span class="line">        EncodeUtil.encode(buf, packet);</span><br><span class="line">        list.add(buf);</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * è§£å¯†</span><br><span class="line">     *</span><br><span class="line">     * @param channelHandlerContext</span><br><span class="line">     * @param buf</span><br><span class="line">     * @param list</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void decode(ChannelHandlerContext channelHandlerContext, ByteBuf buf, List&lt;Object&gt; list) throws Exception &#123;</span><br><span class="line">        list.add(EncodeUtil.decode(buf));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç¼–è§£ç æ—¶ï¼ŒåŒæ ·å€ŸåŠ©äº†Nettyè‡ªèº«çš„MessageToMessageCodecç±»ï¼Œä¿è¯äº†æ¯æ¬¡å‘å‡º/æ¥å—æ¶ˆæ¯æ—¶ï¼Œéƒ½èƒ½èµ°å¯¹åº”ç¼–ç /è§£ç çš„é€»è¾‘ã€‚è¿™ä¹Ÿæ˜¯Nettyçš„å¼ºå¤§ä¹‹å¤„ï¼Œæä¾›äº†è®¸è®¸å¤šå¤šçš„åŸºç¡€ç±»èƒ½å¤Ÿå®Œæˆæˆ‘ä»¬å„ç§ä¸šåŠ¡éœ€æ±‚ã€‚<br>è§£é‡Šäº†å¦‚ä½•å»ä½¿ç”¨è§£ç å’Œç¼–ç ï¼Œé‚£ä¹ˆå°±å¼€å§‹ä»‹ç»è§’è‰²ç™»å½•æ ¡éªŒå–½</p>
<p><strong>å®¢æˆ·ç«¯ï¼š</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@ChannelHandler.Sharable</span><br><span class="line">public class LoginAdapter extends ChannelInboundHandlerAdapter&#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(LoginAdapter.class);</span><br><span class="line"></span><br><span class="line">    public static final LoginAdapter INSTANCE = new LoginAdapter();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;</span><br><span class="line">        LoginRequestPacket packet = new LoginRequestPacket();</span><br><span class="line">        String applicationName = EnvProperties.applicationName;</span><br><span class="line">        String applicationPassword = EnvProperties.applicationPassword;</span><br><span class="line">        packet.setUsername(applicationName);</span><br><span class="line">        packet.setPassword(applicationPassword);</span><br><span class="line">        ctx.writeAndFlush(packet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ChannelInboundHandlerAdapteræ˜¯ChannelInboundHandlerå­ç±»ï¼ŒChannelInboundHandleræ˜¯å¤„ç†è¯»æ•°æ®çš„é€»è¾‘ï¼Œè¿™é‡Œä¸»è¦å€ŸåŠ©äº†å®ƒçš„channelActiveæ–¹æ³•ï¼Œå½“å®¢æˆ·ç«¯è¿æ¥æˆåŠŸæœåŠ¡ç«¯åï¼Œå°±ä¼šè°ƒç”¨æ­¤æ–¹æ³•ï¼Œä»è€ŒæŠŠç™»å½•ä¿¡æ¯å‘é€ç»™æœåŠ¡ç«¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æœåŠ¡ç«¯ï¼š</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@ChannelHandler.Sharable</span><br><span class="line">public class LoginRequestHandler extends SimpleChannelInboundHandler&lt;LoginRequestPacket&gt;&#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(LoginRequestHandler.class);</span><br><span class="line"></span><br><span class="line">    public static final LoginRequestHandler INSTANCE = new LoginRequestHandler();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void channelRead0(ChannelHandlerContext channelHandlerContext, LoginRequestPacket loginRequestPacket) throws Exception &#123;</span><br><span class="line">        //è¿”å›packet</span><br><span class="line">        LoginResponsePacket loginResponsePacket = new LoginResponsePacket();</span><br><span class="line">        if (vail(loginRequestPacket)) &#123;</span><br><span class="line">            String userId = UUID.randomUUID().toString();</span><br><span class="line">            logger.info(&quot;ç”¨æˆ·: &#123;&#125;, å¼€å§‹ç™»å½•ï¼ŒIdä¸º: &#123;&#125;&quot;, loginRequestPacket.getUsername(), userId);</span><br><span class="line">            loginResponsePacket.setUserId(userId);</span><br><span class="line">            loginResponsePacket.setName(loginRequestPacket.getUsername());</span><br><span class="line">            loginResponsePacket.setSucess(true);</span><br><span class="line">            SessionUtil.channelGroup.add(channelHandlerContext.channel());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            loginResponsePacket.setSucess(false);</span><br><span class="line">            loginResponsePacket.setMessage(&quot;ç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        channelHandlerContext.channel().writeAndFlush(loginResponsePacket);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * éªŒè¯ç™»å½•</span><br><span class="line">     *</span><br><span class="line">     * @param loginRequestPacket</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private boolean vail(LoginRequestPacket loginRequestPacket) &#123;</span><br><span class="line">        if (EnvProperties.applicationPassword.equals(loginRequestPacket.getPassword())) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SimpleChannelInboundHandleræ˜¯NettyåŸºäºç®€åŒ–äºŒè¿›åˆ¶æµè½¬åŒ–ä¸ºjavaå¯¹è±¡çš„æŠ½è±¡è€ƒè™‘ï¼Œç»§æ‰¿æ­¤ç±»ï¼Œåœ¨è§£ç åå¾—åˆ°çš„Javaå¯¹è±¡ï¼ŒSimpleChannelInboundHandlerç±»è‡ªåŠ¨ä¼šå¸®æˆ‘ä»¬åˆ¤æ–­å’Œä¼ é€’å¯¹è±¡è¿›å…¥å“ªä¸ªhandlerè¿›è¡Œå¤„ç†ï¼ŒåŒæ—¶SimpleChannelInboundHandlerä¹Ÿæ˜¯ç»§æ‰¿ChannelInboundHandlerï¼ŒchannelRead0()æ–¹æ³•ä¼šå¤„ç†æ”¶åˆ°å®¢æˆ·ç«¯å‘é€åˆ°é¥¿æ¶ˆæ¯ï¼Œåœ¨æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯åï¼Œæ ¡éªŒç™»å½•ï¼Œå¦‚æœæ ¡éªŒé€šè¿‡ï¼Œåˆ™åœ¨SessionUtilä¸­æŠŠæ­¤å®¢æˆ·ç«¯ä¿¡æ¯ä¿å­˜ä¸‹æ¥ï¼Œä»¥ä¾¿ä¸‹æ¬¡ç»™æŒ‡å®šå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼ŒåŒæ—¶å‘é€ä¸ªæ¶ˆæ¯ç»™å®¢æˆ·ç«¯ï¼Œè¡¨ç¤ºç™»å½•æˆåŠŸã€‚</p>
<p><strong>å®¢æˆ·ç«¯ï¼š</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@ChannelHandler.Sharable</span><br><span class="line">public class LoginResponseHandler extends SimpleChannelInboundHandler&lt;LoginResponsePacket&gt;&#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(LoginResponseHandler.class);</span><br><span class="line"></span><br><span class="line">    public static final LoginResponseHandler INSTANCE = new LoginResponseHandler();</span><br><span class="line"></span><br><span class="line">    private static final int HEARTBEAT_INTERVAL = 5;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void channelRead0(ChannelHandlerContext channelHandlerContext, LoginResponsePacket loginResponsePacket) throws Exception &#123;</span><br><span class="line">        if (loginResponsePacket.getSucess()) &#123;</span><br><span class="line">            logger.info(&quot;ç”¨æˆ·Id: &#123;&#125;, ç™»å½•æˆåŠŸ&quot;, loginResponsePacket.getUserId());</span><br><span class="line">            EnvProperties.applicationId = loginResponsePacket.getUserId();</span><br><span class="line">            SessionUtil.addMapUser(new UserDo(loginResponsePacket.getUserId(), loginResponsePacket.getName()), channelHandlerContext.channel());</span><br><span class="line">            //ç™»å½•æˆåŠŸåï¼Œå®šæ—¶å‘é€å¿ƒè·³</span><br><span class="line">            scheduleSendHeartBeat(channelHandlerContext);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            logger.info(&quot;æ—¶é—´: &#123;&#125;, ç™»å½•å¤±è´¥ï¼Œå¤±è´¥åŸå› : &#123;&#125;&quot;, new Date(), loginResponsePacket.getMessage());</span><br><span class="line">            channelHandlerContext.channel().close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * å®šæ—¶å‘é€å¿ƒè·³</span><br><span class="line">     *</span><br><span class="line">     * @param ctx</span><br><span class="line">     */</span><br><span class="line">    private void scheduleSendHeartBeat(ChannelHandlerContext ctx) &#123;</span><br><span class="line">        ctx.executor().schedule(() -&gt; &#123;</span><br><span class="line">            if (ctx.channel().isActive()) &#123;</span><br><span class="line">                logger.info(&quot;å®¢æˆ·ç«¯å‘äº†ä¸€ä¸ªå¿ƒè·³&quot;);</span><br><span class="line">                ctx.writeAndFlush(new HeartRequestPacket());</span><br><span class="line">                scheduleSendHeartBeat(ctx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, HEARTBEAT_INTERVAL, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å®¢æˆ·ç«¯åœ¨æœåŠ¡ç«¯å‘é€æ¶ˆæ¯åï¼Œå¦‚æœæ”¶åˆ°çš„æ˜¯ç™»å½•æˆåŠŸçš„æ¶ˆæ¯ï¼ŒåŒæ ·ä¹Ÿä¼šå°†æ­¤Channelä¿å­˜åœ¨SessionUtilä¸­ï¼Œç›¸ä¿¡ç«¥é‹ä»¬å·²ç»ç•™æ„åˆ°scheduleSendHeartBeat()æ–¹æ³•ï¼Œå®šæ—¶å‘é€å¿ƒè·³æ–¹æ³•ï¼Œè¿™ä¸ªä¼šåœ¨æœ€åä¸€æ®µç»´æŠ¤/æ–­å¼€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡ä¸­å…·ä½“ä»‹ç»ã€‚</p>
<p>å®Œæˆä¸Šé¢é€»è¾‘åï¼Œå¦‚æœå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ ¡éªŒé€šè¿‡åï¼Œåˆ™å¯ä»¥å¤„ç†æ¥ä¸‹æ¥è‡ªå·±å®šä¹‰çš„ä¸šåŠ¡äº†ã€‚</p>
<h5 id="å››ã€æ ¡éªŒé€šè¿‡å®Œæˆè‡ªå·±æ‰€éœ€çš„ä¸šåŠ¡é€šä¿¡é€»è¾‘"><a href="#å››ã€æ ¡éªŒé€šè¿‡å®Œæˆè‡ªå·±æ‰€éœ€çš„ä¸šåŠ¡é€šä¿¡é€»è¾‘" class="headerlink" title="å››ã€æ ¡éªŒé€šè¿‡å®Œæˆè‡ªå·±æ‰€éœ€çš„ä¸šåŠ¡é€šä¿¡é€»è¾‘"></a>å››ã€æ ¡éªŒé€šè¿‡å®Œæˆè‡ªå·±æ‰€éœ€çš„ä¸šåŠ¡é€šä¿¡é€»è¾‘</h5><p>è¿™éƒ¨åˆ†å…¶å®è·Ÿç”¨æˆ·ç™»å½•æ ¡éªŒçš„å®ç°é€»è¾‘ç±»ä¼¼ï¼Œå®ç°çš„æ­¥éª¤ï¼šå®šä¹‰å„è‡ªçš„Requestå’ŒResponseçš„Packetï¼ŒåŒæ—¶åˆ›å»ºå¯¹åº”çš„æŒ‡ä»¤ï¼ŒæŠŠæŒ‡ä»¤æ”¾å…¥å¯¹åº”çš„mapä¸­ï¼Œç„¶åæ ¹æ®ä¸šåŠ¡åœºæ™¯å­˜å‚¨å¯¹åº”ä¼ é€’çš„æ¶ˆæ¯å€¼ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†å“ˆã€‚</p>
<h4 id="ç»´æŠ¤-æ–­å¼€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡"><a href="#ç»´æŠ¤-æ–­å¼€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡" class="headerlink" title="ç»´æŠ¤/æ–­å¼€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡"></a>ç»´æŠ¤/æ–­å¼€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡</h4><p>ä»¥ä¸Šå·²ç»è®²å®Œäº†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹è¿æ¥ä»¥åŠæ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶ï¼Œé‚£ä¹ˆå®é™…çš„åœºæ™¯è‚¯å®šä¼šå­˜åœ¨ï¼Œæ­¤å®¢æˆ·ç«¯å‘é€å®Œæ¶ˆæ¯åï¼Œåœ¨æ¥ä¸‹æ¥ä¸€æ®µæ—¶é—´åéƒ½ä¸ä¼šæœ‰æ¶ˆæ¯å¾€æ¥ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥å®šä¹‰åœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œå¦‚æœæ¶ˆæ¯ä¼ é€’ï¼Œå°±æŠŠæ­¤é“¾æ¥å…³é—­ï¼Œä»¥èµ·åˆ°èŠ‚çœèµ„æºçš„ç›®çš„ã€‚å½“ç„¶ä¹Ÿä¼šå­˜åœ¨è¯´ï¼Œå¼ºåˆ¶éœ€è¦ä¿è¯æ­¤è¿æ¥å»ºç«‹çš„æƒ…å†µï¼Œé‚£ä¹ˆæ¥ä¸‹å»å°±ä¼šå»ä»‹ç»å¦‚ä½•å»å®ç°è¿™ä¸¤ä¸ªåœºæ™¯éœ€æ±‚ã€‚</p>
<p><strong>å¿ƒè·³æ£€æµ‹ï¼š</strong></p>
<p>è¿™ä¸ªå…¶å®åœ¨ä¸Šé¢çš„æ—¶å€™å·²ç»å‡ºç°è¿‡ï¼Œå°±æ˜¯å®šæ—¶å‘é€å¿ƒè·³çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šå£°æ˜å¿ƒè·³çš„Requestå’ŒResponseçš„Packetï¼Œå¹¶è®¾ç½®åœ¨å®šæ—¶å™¨ï¼Œå®šæ—¶å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ï¼Œå½“ç„¶è¿™ä¸ªæ—¶é—´ä¸€èˆ¬ä¸ºä¸‹é¢æåˆ°çš„ç©ºé—²æ£€æµ‹æ—¶é—´çš„ä¸‰åˆ†ä¹‹ä¸€ã€‚</p>
<p><strong>æ£€æµ‹ç©ºé—²æ—¶é—´ï¼š</strong></p>
<p>ç©ºé—²æ£€æµ‹æŒ‡çš„æ˜¯æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œæ£€æµ‹è¿™æ®µæ—¶é—´å†…æ˜¯å¦æœ‰æ•°æ®è¯»å†™ï¼Œç®€åŒ–ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„æœåŠ¡ç«¯åªéœ€è¦æ£€æµ‹ä¸€æ®µæ—¶é—´å†…ï¼Œæ˜¯å¦æ”¶åˆ°è¿‡å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®å³å¯ï¼ŒNetty è‡ªå¸¦çš„ IdleStateHandler å°±å¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class IMIdleStateHandler extends IdleStateHandler&#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(IMIdleStateHandler.class);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * ç©ºé—²æ—¶é—´</span><br><span class="line">     */</span><br><span class="line">    private static final int TIME_DE = 15;</span><br><span class="line"></span><br><span class="line">    public IMIdleStateHandler() &#123;</span><br><span class="line">        super(TIME_DE, 0, 0, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void channelIdle(ChannelHandlerContext ctx, IdleStateEvent evt) &#123;</span><br><span class="line">        logger.info(&quot;&#123;&#125; ç§’å†…æœªè¯»å–åˆ°æ•°æ®ï¼Œå…³é—­è¿æ¥&quot;, TIME_DE);</span><br><span class="line">        ctx.channel().close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IMIdleStateHandlerç±»ç»§æ‰¿äº†IdleStateHandlerç±»ï¼Œä¿è¯è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨15så†…æœªå‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ï¼Œåˆ™æœåŠ¡ç«¯ä¼šè°ƒç”¨channelIdle()æ–¹æ³•ï¼Œä»è€Œå…³é—­æ­¤é“¾æ¥ã€‚</p>
<h4 id="çŸ¥è¯†ç‚¹ä»‹ç»-copyäºå¤§ç¥æ•´ç†çš„è¯­è¨€"><a href="#çŸ¥è¯†ç‚¹ä»‹ç»-copyäºå¤§ç¥æ•´ç†çš„è¯­è¨€" class="headerlink" title="çŸ¥è¯†ç‚¹ä»‹ç»(copyäºå¤§ç¥æ•´ç†çš„è¯­è¨€)"></a>çŸ¥è¯†ç‚¹ä»‹ç»(copyäºå¤§ç¥æ•´ç†çš„è¯­è¨€)</h4><h5 id="OutBoundHandlerã€InboundHandler"><a href="#OutBoundHandlerã€InboundHandler" class="headerlink" title="OutBoundHandlerã€InboundHandler"></a>OutBoundHandlerã€InboundHandler</h5><p>Nettyä¸­pipeline ä¸ channelHandler çš„æ„æˆ</p>
<p><img src="http://yunkai-wjd.oss-cn-beijing.aliyuncs.com/blog_pie_handler.jpg?Expires=1546251181&amp;OSSAccessKeyId=TMP.AQHv0OmkU7XCzkD8oC_XF35Ox5UTzZriu9ergiU9rBXOVze9-GW8UdXVSr0iMC4CFQDPbpufEaT4VrRcy-y92BO-QNwmzAIVALrOeUq8BgoDIt0yANMZoIHuc_78&amp;Signature=2V8BSpmm2ua6YfbaLj1Pcy5IJ38%3D" alt="pipe"></p>
<p>æ— è®ºæ˜¯ä»æœåŠ¡ç«¯æ¥çœ‹ï¼Œè¿˜æ˜¯å®¢æˆ·ç«¯æ¥çœ‹ï¼Œåœ¨ Netty æ•´ä¸ªæ¡†æ¶é‡Œé¢ï¼Œä¸€æ¡è¿æ¥å¯¹åº”ç€ä¸€ä¸ª Channelï¼Œè¿™æ¡ Channel æ‰€æœ‰çš„å¤„ç†é€»è¾‘éƒ½åœ¨ä¸€ä¸ªå«åš ChannelPipeline çš„å¯¹è±¡é‡Œé¢ï¼ŒChannelPipeline æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ï¼Œä»–å’Œ Channel ä¹‹é—´æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚</p>
<p>ChannelPipeline é‡Œé¢æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª ChannelHandlerContext å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡èƒ½å¤Ÿæ‹¿åˆ°å’Œ Channel ç›¸å…³çš„æ‰€æœ‰çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç„¶åè¿™ä¸ªå¯¹è±¡åŒ…ç€ä¸€ä¸ªé‡è¦çš„å¯¹è±¡ï¼Œé‚£å°±æ˜¯é€»è¾‘å¤„ç†å™¨ ChannelHandlerã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬åœ¨æœåŠ¡ç«¯çš„childHandler()æ–¹æ³•å’Œå®¢æˆ·ç«¯handler()æ–¹æ³•å†…æ³¨å†Œçš„å…¶å®éƒ½æ˜¯ä¸€ä¸ªä¸ªChannelHandlerï¼Œä»è€ŒæŠŠç›¸å…³çš„é€»è¾‘ä¸²è”èµ·æ¥ã€‚(è¿™ä¸ªæ˜¯ä¸ªäººç†è§£å“¦)</p>
<p>ChannelHandlerçš„åˆ†ç±»ï¼ŒChannelHandleræœ‰ä¸¤å¤§å­æ¥å£ï¼šChannelInboundHandlerå’ŒChannelOutBoundHandlerï¼ŒChannelInboundHandleræ˜¯å¤„ç†è¯»é€»è¾‘ï¼Œå¤„ç†è¯»åˆ°çš„æ•°æ®ï¼Œæ•°æ®å¯¹è±¡ä¼šä¸€å±‚å±‚ä¼ é€’ï¼Œå½“ç„¶å‰ææ˜¯ä¼ é€’çš„å¯¹è±¡æ»¡è¶³ChannelHandlerä¸­å£°æ˜å¯¹è±¡ç±»å‹ã€‚ChannelOutBoundHandleræ˜¯å¤„ç†å†™é€»è¾‘ï¼ŒåŒæ ·ä¹Ÿä¼šé€å±‚å¤„ç†å¯¹è±¡ï¼Œå½“ç„¶ä¹Ÿå­˜åœ¨æ»¡è¶³å¯¹è±¡ç±»å‹çš„æ¡ä»¶ã€‚<br>ChannelInboundHandlerå’ŒChannelOutBoundHandleråœ¨æœåŠ¡ç«¯childHandler()å’Œå®¢æˆ·ç«¯handler()æ‰§è¡Œé¡ºåºå’Œå†™çš„é¡ºåºæœ‰å…³ç³»å“¦ï¼ŒChannelInboundHandleræ˜¯å†™åœ¨å‰é¢çš„ä¼˜å…ˆæ‰§è¡Œè€ŒChannelOutBoundHandleråˆ™åˆšå¥½ç›¸åã€‚</p>
<h5 id="ChannelHandlerçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#ChannelHandlerçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ChannelHandlerçš„ç”Ÿå‘½å‘¨æœŸ"></a>ChannelHandlerçš„ç”Ÿå‘½å‘¨æœŸ</h5><p>1ã€handlerAdded() ï¼šè¡¨ç¤ºåœ¨å½“å‰çš„ channel ä¸­ï¼Œå·²ç»æˆåŠŸæ·»åŠ äº†ä¸€ä¸ª handler å¤„ç†å™¨;<br>2ã€channelRegistered()ï¼šè¿™ä¸ªå›è°ƒæ–¹æ³•ï¼Œè¡¨ç¤ºå½“å‰çš„ channel çš„æ‰€æœ‰çš„é€»è¾‘å¤„ç†å·²ç»å’ŒæŸä¸ª NIO çº¿ç¨‹å»ºç«‹äº†ç»‘å®šå…³ç³»;<br>3ã€channelActive()ï¼šå½“ channel çš„æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘é“¾å‡†å¤‡å®Œæ¯•ï¼ˆä¹Ÿå°±æ˜¯è¯´ channel çš„ pipeline ä¸­å·²ç»æ·»åŠ å®Œæ‰€æœ‰çš„ handlerï¼‰ä»¥åŠç»‘å®šå¥½ä¸€ä¸ª NIO çº¿ç¨‹ä¹‹åï¼Œè¿™æ¡è¿æ¥ç®—æ˜¯çœŸæ­£æ¿€æ´»äº†ï¼Œæ¥ä¸‹æ¥å°±ä¼šå›è°ƒåˆ°æ­¤æ–¹æ³•ã€‚<br>4ã€channelRead()ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘æ¥æ•°æ®ï¼Œæ¯æ¬¡éƒ½ä¼šå›è°ƒæ­¤æ–¹æ³•ï¼Œè¡¨ç¤ºæœ‰æ•°æ®å¯è¯»ã€‚<br>5ã€channelReadComplete()ï¼šæœåŠ¡ç«¯æ¯æ¬¡è¯»å®Œä¸€æ¬¡å®Œæ•´çš„æ•°æ®ä¹‹åï¼Œå›è°ƒè¯¥æ–¹æ³•ï¼Œè¡¨ç¤ºæ•°æ®è¯»å–å®Œæ¯•ã€‚<br>6ã€channelInactive(): è¡¨é¢è¿™æ¡è¿æ¥å·²ç»è¢«å…³é—­äº†ï¼Œè¿™æ¡è¿æ¥åœ¨ TCP å±‚é¢å·²ç»ä¸å†æ˜¯ ESTABLISH çŠ¶æ€äº†<br>7ã€channelUnregistered(): æ—¢ç„¶è¿æ¥å·²ç»è¢«å…³é—­ï¼Œé‚£ä¹ˆä¸è¿™æ¡è¿æ¥ç»‘å®šçš„çº¿ç¨‹å°±ä¸éœ€è¦å¯¹è¿™æ¡è¿æ¥è´Ÿè´£äº†ï¼Œè¿™ä¸ªå›è°ƒå°±è¡¨æ˜ä¸è¿™æ¡è¿æ¥å¯¹åº”çš„ NIO çº¿ç¨‹ç§»é™¤æ‰å¯¹è¿™æ¡è¿æ¥çš„å¤„ç†<br>8ã€handlerRemoved()ï¼šæœ€åï¼Œæˆ‘ä»¬ç»™è¿™æ¡è¿æ¥ä¸Šæ·»åŠ çš„æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘å¤„ç†å™¨éƒ½ç»™ç§»é™¤æ‰ã€‚</p>
<h5 id="ChannelHandlerContext-writeAndFlush-å’ŒChannelHandlerContext-channel-writeAndFlush-æ–¹æ³•åŒºåˆ«"><a href="#ChannelHandlerContext-writeAndFlush-å’ŒChannelHandlerContext-channel-writeAndFlush-æ–¹æ³•åŒºåˆ«" class="headerlink" title="ChannelHandlerContext.writeAndFlush()å’ŒChannelHandlerContext.channel().writeAndFlush()æ–¹æ³•åŒºåˆ«"></a>ChannelHandlerContext.writeAndFlush()å’ŒChannelHandlerContext.channel().writeAndFlush()æ–¹æ³•åŒºåˆ«</h5><p>è°ƒç”¨ ctx.writeAndFlush() å¯ä»¥ç›´æ¥ä¸€å£æ°”æŠŠå¯¹è±¡é€åˆ° codec ä¸­ç¼–ç ï¼Œç„¶åå†™å‡ºå»ï¼Œå³æ— éœ€å†ç»è¿‡å…¶ä»–çš„outBoundã€‚<br>ctx.channel().writeAndFlush() æ˜¯ä» pipeline é“¾ä¸­çš„æœ€åä¸€ä¸ª outBound ç±»å‹çš„ handler å¼€å§‹ï¼ŒæŠŠå¯¹è±¡å¾€å‰è¿›è¡Œä¼ æ’­ï¼Œå¦‚æœä½ ç¡®è®¤å½“å‰åˆ›å»ºçš„å¯¹è±¡éœ€è¦ç»è¿‡åé¢çš„ outBound ç±»å‹çš„ handlerï¼Œé‚£ä¹ˆå°±è°ƒç”¨æ­¤æ–¹æ³•ã€‚<br>ctx.channel().writeAndFlush()ï¼Œå¯¹è±¡ä¼šä»æœ€åä¸€ä¸ª outBound ç±»å‹çš„ handler å¼€å§‹ï¼Œé€ä¸ªå¾€å‰è¿›è¡Œä¼ æ’­ï¼Œè·¯å¾„æ˜¯è¦æ¯” ctx.writeAndFlush() è¦é•¿çš„ã€‚</p>
<h5 id="ChannelHandler-Sharable"><a href="#ChannelHandler-Sharable" class="headerlink" title="@ChannelHandler.Sharable"></a>@ChannelHandler.Sharable</h5><p>@ChannelHandler.Sharable æ˜¯Nettyæä¾›çš„æ³¨è§£ï¼Œæ˜¾ç¤ºåœ°å‘Šè¯‰ Nettyï¼Œè¿™ä¸ª handler æ˜¯æ”¯æŒå¤šä¸ª channel å…±äº«çš„ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚å½“æ‰€æœ‰çš„é“¾æ¥æ‰€å¤„ç†çš„é€»è¾‘æ˜¯æŠ‘åˆ¶æ—¶ï¼Œå¯ä»¥æŠŠæ­¤HandleråŠ ä¸Šè¿™ä¸ªæ³¨é‡Šï¼Œé‚£ä¹ˆæ¯ä¸ªHandlerå°±æ— éœ€åœ¨Newï¼ŒèŠ‚çœäº†ä¸€å®šçš„å†…å­˜ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>äº‘å¼€ä¹Ÿæ˜¯ä¹‹å‰è´­ä¹°äº†æ˜é‡‘_é—ªç”µä¾ å¤§ä½¬çš„ã€ŠNetty å…¥é—¨ä¸å®æˆ˜ï¼šä»¿å†™å¾®ä¿¡ IM å³æ—¶é€šè®¯ç³»ç»Ÿã€‹ï¼Œç”±äºåœ¨å°å†Œä¸­å¤§ä½¬è®²çš„å¾ˆè¯¦ç»†ï¼Œäº‘å¼€æƒ³åœ¨ä¸€ç¯‡åšå®¢ä¸­ä»‹ç»å®Œå…¨æ˜¾ç„¶æ˜¯ä¸å¯èƒ½çš„ï¼Œå†™è¿™ç¯‡åšå®¢ä¹Ÿæ˜¯è‡ªå·±æƒ³å¯¹å­¦ä¹ ç»“æœçš„æ€»ç»“ï¼Œè·ç¦»å­¦ä¹ ç»“æŸä¹Ÿæœ‰å‡ ä¸ªæœˆæ—¶é—´äº†ï¼Œæœ‰äº›ç‚¹æ¸©æ•…äº†éå°å†Œæ‰æ‰¾åˆ°äº†æ„Ÿè§‰ï¼Œå¤§å®¶å¦‚æœè§‰å¾—è®²å¾—ä¸å¯¹çš„åœ°æ–¹å¯ä»¥åŠ æˆ‘å¾®ä¿¡å‘ŠçŸ¥æˆ‘å“ˆï¼Œå¾®ä¿¡å·ï¼šwjd_632479475ï¼Œå¦‚æœæƒ³æ›´å…·ä½“äº†è§£ä¸‹Nettyå¯ä»¥ç‚¹æˆ‘ä¸‹é¢çš„Linksï¼Œé‡Œé¢æ˜¯æ˜é‡‘å°æµ‹çš„åœ°å€å“¦ã€‚</p>
<p>æœ€åç¥å¤§å®¶æ–°å¹´å¿«ä¹ï¼Œ2019å¹´å¿ƒæƒ³äº‹æˆã€‚<br>                                            2018_12_31  äº‘å¼€</p>
<p>é™„ï¼š<a href="https://github.com/JiongJiongGe/netty.server" target="_blank" rel="noopener">GitHubé¡¹ç›®é“¾æ¥åœ°å€_æœåŠ¡ç«¯</a><br><a href="https://github.com/JiongJiongGe/netty.client" target="_blank" rel="noopener">GitHubé¡¹ç›®é“¾æ¥åœ°å€_å®¢æˆ·ç«¯</a></p>
<p>Linksï¼š<br><a href="https://juejin.im/book/5b4bc28bf265da0f60130116/section/5b6a1a9cf265da0f87595521" target="_blank" rel="noopener">æ˜é‡‘é—ªç”µä¾ å°å†Œé“¾æ¥</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/SpringBoot/">SpringBoot</a><a href="/tags/Netty/">Netty</a><a href="/tags/NIO/">NIO</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 äº‘å¼€
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>