<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>å•ä¾‹é¿å…å¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸ªå€¼ä»è€Œé€ æˆè„æ•°æ® | å®ˆå¾—äº‘å¼€è§æœˆæ˜</title>

  
  <meta name="author" content="äº‘å¼€">
  

  
  <meta name="description" content="åœ¨ITæµ·æ´‹æ‰“æ»šçš„å°ğŸ³">
  

  
  
  <meta name="keywords" content="singleton">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="å•ä¾‹é¿å…å¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸ªå€¼ä»è€Œé€ æˆè„æ•°æ®"/>

  <meta property="og:site_name" content="å®ˆå¾—äº‘å¼€è§æœˆæ˜"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="å®ˆå¾—äº‘å¼€è§æœˆæ˜" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">å®ˆå¾—äº‘å¼€è§æœˆæ˜</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">é¦–é¡µ</a></li>
      
        <li><a href="/about">å…³äº</a></li>
      
        <li><a href="/archives">å½’æ¡£</a></li>
      
        <li><a href="/tags">æ ‡ç­¾</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>å•ä¾‹é¿å…å¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸ªå€¼ä»è€Œé€ æˆè„æ•°æ®</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/10/29/yunkai_singleton/" rel="bookmark">
        <time class="entry-date published" datetime="2017-10-29T05:44:10.000Z">
          2017-10-29
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>å•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§å¸¸ç”¨çš„è½¯ä»¶è®¾è®¡æ¨¡å¼ã€‚å•ä¾‹å¯ä»¥ä¿è¯ç³»ç»Ÿä¸­ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå³ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚<br>ä¼˜ç‚¹ï¼š<br>&nbsp;&nbsp;&nbsp;(1)ã€å®ä¾‹æ§åˆ¶<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å•ä¾‹ä¼šé˜»æ­¢å…¶ä»–å¯¹è±¡å®ä¾‹åŒ–å…¶è‡ªå·±çš„å¯¹è±¡å‰¯æœ¬ï¼Œä»è€Œç¡®ä¿æ‰€æœ‰å¯¹è±¡éƒ½è®¿é—®å”¯ä¸€å®ä¾‹ã€‚<br>&nbsp;&nbsp;&nbsp;(2)ã€èŠ‚çº¦ç³»ç»Ÿèµ„æº<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºç³»ç»Ÿå†…å­˜ä¸­åªå­˜åœ¨ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤å¯ä»¥èŠ‚çº¦å¯¹è±¡é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ã€‚<a id="more"></a><br>ç¼ºç‚¹ï¼š<br>&nbsp;&nbsp;&nbsp;(1)ã€æ»¥ç”¨å¸¦æ¥çš„é—®é¢˜<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è‹¥å•ä¾‹å¯¹è±¡é•¿æ—¶é—´ä¸è¢«åˆ©ç”¨ï¼Œç³»ç»Ÿä¼šè®¤ä¸ºæ˜¯åƒåœ¾è€Œå›æ”¶ï¼Œä»è€Œå¯¼è‡´å¯¹è±¡çŠ¶æ€çš„ä¸¢å¤±ã€‚æ­¤å¤–ï¼Œå¦‚æœä¸ºäº†èŠ‚çœèµ„æºå°†æ•°æ®åº“è¿æ¥æ± å¯¹è±¡è®¾è®¡ä¸ºå•ä¾‹ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…±äº«è¿æ¥æ± å¯¹è±¡çš„ç¨‹åºè¿‡å¤šè€Œå‡ºç°è¿æ¥æ± æº¢å‡ºã€‚<br>&nbsp;&nbsp;&nbsp;(2)ã€æ‰©å±•æ€§è¾ƒå·®<br>ç”±äºå•ä¾‹æ¨¡å¼ä¸­æ²¡æœ‰æŠ½è±¡å±‚ï¼Œå› æ­¤æ‰©å±•æœ‰å¾ˆå¤§çš„å›°éš¾ã€‚</p>
<h2 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h2><p>å¼€å‘è¿‡å¾®ä¿¡å…¬ä¼—å·çš„åŒå­¦åº”è¯¥éƒ½æ¥è§¦è¿‡å¾®ä¿¡çš„AccessTokenï¼Œæ­£å¸¸æƒ…å†µä¸‹AccessTokenæœ‰æ•ˆæœŸä¸º7200ç§’ï¼Œåœ¨æœ‰æ•ˆæœŸå†…é‡å¤è·å–è¿”å›ç›¸åŒç»“æœã€‚ä½†æ˜¯å½“AccessTokenæœ‰æ•ˆæœŸè¾¾åˆ°ä¸´ç•Œç‚¹æ—¶ï¼Œä¼šå­˜åœ¨å¤šä¸ªç”¨æˆ·è®¿é—®åŒä¸ªå…¬ä¼—å·æ—¶ï¼ŒåŒæ—¶å»ä¿®æ”¹ç¨‹åºä¸­å…¬ä¼—å·çš„AccessTokenå€¼ï¼Œå¦‚æœå¤„ç†ä¸å½“ï¼Œåˆ™ä¼šå­˜åœ¨AccessTokenè¢«å¤šæ¬¡ä¿®æ”¹ï¼Œä»è€Œå‡ºç°AccessTokençš„è„æ•°æ®ï¼Œå¯¼è‡´å‰å‡ æ¬¡çš„ç”¨æˆ·è®¿é—®å‡ºç°å¯¹åº”çš„AccessTokenè¢«ä¿®æ”¹ä»è€Œå‡ºç°é”™è¯¯ã€‚</p>
<h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>JDK 1.8.0_131ã€MAVEN apache-maven-3.5.0</p>
<h3 id="æŠ€æœ¯æ ˆ"><a href="#æŠ€æœ¯æ ˆ" class="headerlink" title="æŠ€æœ¯æ ˆ"></a>æŠ€æœ¯æ ˆ</h3><p>SpringBootã€Mybatis</p>
<h3 id="å¼€å‘å·¥å…·"><a href="#å¼€å‘å·¥å…·" class="headerlink" title="å¼€å‘å·¥å…·"></a>å¼€å‘å·¥å…·</h3><p>IntelliJ IDEA 2(å¼€å‘å·¥å…·å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½è€Œå®š)</p>
<h3 id="å®è·µè¿‡ç¨‹"><a href="#å®è·µè¿‡ç¨‹" class="headerlink" title="å®è·µè¿‡ç¨‹"></a>å®è·µè¿‡ç¨‹</h3><p>ä¸€ã€æ–°å»ºSpringBooté¡¹ç›®,å¹¶åŠ å…¥redisä¾èµ–ï¼š<br>redis ä¾èµ–<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p>ä¾èµ–è¯´æ˜ï¼šredisçš„å¼•ç”¨ï¼Œåœ¨æœ¬ç¯‡æŠ€æœ¯ä¸­æ˜¯ä¸ºäº†ä¿è¯å•ä¾‹å¯¹è±¡æŒä¹…åŒ–ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥é‡‡ç”¨ç›´æ¥æŠŠJavaå¯¹è±¡ä¿å­˜åœ¨æ–‡ä»¶ä¸­æˆ–è€…åœ¨DBä¸­å°†å¯¹è±¡ä¿å­˜èµ·æ¥çš„æ–¹æ³•ã€‚å‡ºäºè§£å†³å½“é¡¹ç›®é‡å¯æ—¶ï¼ŒåŸå…ˆå•ä¾‹å¯¹è±¡ä¸¢å¤±æ•°æ®çš„é—®é¢˜ã€‚</p>
<p>äºŒã€æ„å»ºå¤§å®¶çš„è€æœ‹å‹CalmWangUserModelç”¨æˆ·å¯¹è±¡ï¼Œä»¥åŠå¯¹åº”çš„Daoå±‚å’ŒServiceå±‚æ–¹æ³•ã€‚ç”±äºå¼€å‘ç¯å¢ƒçš„çº¦æŸï¼Œæ— æ³•å®ç°ä»å¾®ä¿¡æ¢å–AccessTokenä¿å­˜åœ¨å•ä¾‹å¯¹è±¡ä¸­ï¼Œæ•…åœ¨å¼€å‘ç¯å¢ƒä¸­é‡‡ç”¨ä»DBä¸­æ‹¿æ•°æ®ï¼Œä»¥æ¨¡æ‹Ÿå®Œæˆä¸Šè¿°æ“ä½œã€‚</p>
<p>ä¸‰ã€å•ä¾‹å¯¹è±¡å£°æ˜ï¼Œå¹¶ç¼–å†™è®¾ç½®å’Œè·å–å¯¹è±¡å±æ€§<br>æœ¬ç¯‡ä¸­å•ä¾‹çš„å®ç°æ˜¯åŒé‡æ ¡éªŒé”çš„å½¢å¼ï¼Œåœ¨JDK1.5ä¹‹åï¼ŒåŒé‡æ£€æŸ¥é”å®šæ‰èƒ½å¤Ÿæ­£å¸¸è¾¾åˆ°å•ä¾‹æ•ˆæœã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class UserSingleton &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(UserSingleton.class);</span><br><span class="line"></span><br><span class="line">    private LinkedHashMap&lt;String, String&gt; linkMap;</span><br><span class="line"></span><br><span class="line">    private volatile static UserSingleton userSingleton;</span><br><span class="line"></span><br><span class="line">    private UserSingleton()&#123;&#125;</span><br><span class="line"></span><br><span class="line">    public LinkedHashMap&lt;String, String&gt; getLinkMap() &#123;</span><br><span class="line">        return linkMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setLinkMap(LinkedHashMap&lt;String, String&gt; linkMap) &#123;</span><br><span class="line">        this.linkMap = linkMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜ï¼š<br>(1)ã€å½“ä½¿ç”¨volatileå£°æ˜çš„å˜é‡çš„å€¼ï¼Œç³»ç»Ÿæ€»æ˜¯é‡æ–°ä»å®ƒæ‰€åœ¨çš„å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œå³ä½¿å®ƒå‰é¢çš„æŒ‡ä»¤åˆšåˆšä»è¯¥å¤„è¯»å–è¿‡æ•°æ®ã€‚<br>(2)ã€LinkedHashMapç›¸å¯¹äºHashMapçš„ç‰¹ç‚¹å°±æ˜¯ä¿å­˜äº†è®°å½•çš„æ’å…¥é¡ºåºã€‚æ­¤å¤„ç”¨linkMapæ˜¯å•ä¾‹å¯¹è±¡çš„ä¸€ä¸ªå±æ€§ï¼Œæ¥ä¿å­˜ç”¨æˆ·åå’Œè”ç³»æ–¹å¼çš„keyï¼Œvalueå½¢å¼ï¼Œå³æ¨¡æ‹Ÿå­˜å‚¨å•†å®¶å¾®ä¿¡å…¬ä¼—å·çš„appIDå’ŒAccessTokenå€¼ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static String getUserSingletonValue(String key)&#123;</span><br><span class="line">        if(userSingleton == null)&#123;</span><br><span class="line">            synchronized (UserSingleton.class)&#123;</span><br><span class="line">                if(userSingleton == null)&#123;</span><br><span class="line">                    userSingleton = new UserSingleton();</span><br><span class="line">                    LinkedHashMap&lt;String, String&gt; map = new LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">                    userSingleton.setLinkMap(map);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(&quot;userSingleton = &#123;&#125;&quot;, new Gson().toJson(userSingleton));</span><br><span class="line">        return userSingleton.getLinkMap().get(key);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜UserSingletonç±»æ–¹æ³•ï¼š<br>(1)ã€ä½¿ç”¨synchronized(åŒæ­¥é”)ï¼Œè¡¨ç¤ºsynchronizedçš„ä»£ç åœ¨æ‰§è¡Œå‰å¿…é¡»é¦–å…ˆè·å¾—UserSingletonç±»çš„é”æ–¹èƒ½æ‰§è¡Œï¼Œå¦åˆ™æ‰€å±çº¿ç¨‹é˜»å¡ï¼Œæ–¹æ³•ä¸€æ—¦æ‰§è¡Œï¼Œå°±ç‹¬å è¯¥é”ï¼Œç›´åˆ°ä»è¯¥æ–¹æ³•è¿”å›æ—¶æ‰å°†é”é‡Šæ”¾ï¼Œä»è€Œä¿è¯userSingletonä¸ºå”¯ä¸€å®ä¾‹ã€‚<br>(2)ã€æ­¤æ–¹æ³•åŠŸèƒ½ä¸»è¦æ˜¯é€šè¿‡keyï¼Œæ¥å•ä¾‹å¯¹è±¡ä¸­è·å–å¯¹åº”çš„valueå€¼ï¼Œå¦‚æœå¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå¯¹è±¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public static UserSingleton setUserSingleton(String key, String value)&#123;</span><br><span class="line">        synchronized (UserSingleton.class)&#123;</span><br><span class="line">            LinkedHashMap&lt;String, String&gt; map = userSingleton.getLinkMap();</span><br><span class="line">            if(StringUtils.isEmpty(map.get(key)))&#123;</span><br><span class="line">                map.put(key, value);</span><br><span class="line">                userSingleton.setLinkMap(map);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(&quot;userSingleton = &#123;&#125;&quot;, new Gson().toJson(userSingleton));</span><br><span class="line">        return userSingleton;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜UserSingletonç±»æ–¹æ³•ï¼š<br>synchronizedçš„ç”¨æ³•å’Œä½œç”¨å¦‚ä¸Šï¼Œæ­¤æ–¹æ³•ç”¨äºå°†keyå’Œvalueå€¼å­˜å…¥linkmapå¯¹è±¡ä¸­ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static LinkedHashMap&lt;String, String&gt; getUserSingleton()&#123;</span><br><span class="line">        if(userSingleton == null)&#123;</span><br><span class="line">            synchronized (UserSingleton.class)&#123;</span><br><span class="line">                if(userSingleton == null)&#123;</span><br><span class="line">                    userSingleton = new UserSingleton();</span><br><span class="line">                    LinkedHashMap&lt;String, String&gt; map = new LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">                    userSingleton.setLinkMap(map);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(&quot;userSingleton = &#123;&#125;&quot;, new Gson().toJson(userSingleton));</span><br><span class="line">        return userSingleton.getLinkMap();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜UserSingletonç±»æ–¹æ³•ï¼š<br>synchronizedçš„ç”¨æ³•å’Œä½œç”¨å¦‚ä¸Šï¼Œæ­¤æ–¹æ³•ç”¨æˆ·è·å–å•ä¾‹ä¸­linkmapå¯¹è±¡ã€‚</p>
<p>å››ã€é€šè¿‡keyå€¼è·å–å•ä¾‹å¯¹è±¡å¯¹åº”çš„valueå€¼<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;singleton&quot;)</span><br><span class="line">    public String singleton(String key)&#123;</span><br><span class="line">       String value = singleApplyService.retun(key);</span><br><span class="line">       logger.info(&quot;userName = &#123;&#125;&quot;, value);</span><br><span class="line">       return value;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»£ç è¯´æ˜ï¼š<br>ç”¨æˆ·æ¥å—è¯·æ±‚çš„æ§åˆ¶å™¨ï¼Œè°ƒç”¨serviceä¸­çš„é€»è¾‘ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public String retun(String key)&#123;</span><br><span class="line">        //(1)</span><br><span class="line">        String value = UserSingleton.getUserSingletonValue(key);</span><br><span class="line">        if(StringUtils.isEmpty(value))&#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                logger.info(&quot;in = in&quot;);</span><br><span class="line">                //(2)</span><br><span class="line">                CalmWangUserModel user = calmWangUserService.getByPhone(key);</span><br><span class="line">                //(3)</span><br><span class="line">                UserSingleton.setUserSingleton(key, user.getUserName());</span><br><span class="line">                //(4)</span><br><span class="line">                LinkedHashMap&lt;String, String&gt; map = UserSingleton.getUserSingleton();</span><br><span class="line">                redisService.setKeyValue(&quot;all&quot;, map);</span><br><span class="line">                value = UserSingleton.getUserSingletonValue(key);</span><br><span class="line">            &#125;catch (Exception e)&#123;</span><br><span class="line">                logger.error(&quot;error = &#123;&#125;&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜ï¼š<br>(1)ã€é€šè¿‡keyå€¼ï¼Œä»å•ä¾‹å¯¹è±¡ä¸­è·å–å¯¹åº”çš„valueå€¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šæ‰§è¡Œå¯¹åº”çš„é€»è¾‘ï¼Œå¦‚æœå­˜åœ¨åˆ™å°†valueå€¼è¿”å›ã€‚<br>(2)ã€keyå¯¹åº”çš„valueå€¼ä¸å­˜åœ¨ï¼Œåˆ™ä»DBä¸­è·å–å¯¹åº”çš„ä¿¡æ¯å€¼ï¼Œæ­¤å¤„é¢„æ¨¡æ‹Ÿè¯·æ±‚å¾®ä¿¡æ¥å£è·å–å¯¹åº”çš„AccessTokenå€¼ã€‚<br>(3)ã€å°†æ–°è·å–çš„valueå€¼å’Œkeyå€¼ä¸€èµ·ä¿å­˜å…¥å•ä¾‹ä¸­ã€‚<br>(4)ã€ä¸ºä¿è¯å•ä¾‹å¯¹è±¡çš„æŒä¹…åŒ–ï¼Œæ•…å°†å•ä¾‹ä¸­çš„linkmapå±æ€§å€¼å­˜å…¥redisä¸­ï¼Œå¹¶ä¼šåˆ›å»ºBeanï¼Œå½“Springå®¹å™¨åœ¨å¯åŠ¨æ—¶ï¼Œå»æ³¨å…¥Bean,å°†redisä¸­linkmapå€¼å­˜å…¥å•ä¾‹ä¸­ã€‚(è¯´åˆ°Springå®¹å™¨å¯åŠ¨åªæ˜¯ä¸€ç§æ¯”è¾ƒå¸¸è§å•ä¾‹å¯¹è±¡é”€æ¯çš„æƒ…å†µï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å‘å¸ƒé¡¹ç›®ç‰ˆæœ¬æ—¶ï¼Œè¿™ç§æƒ…å†µå‡ºç°çš„é¢‘ç‡è¿˜æ˜¯æ¯”è¾ƒé«˜çš„)</p>
<p>äº”ã€redisæŒä¹…åŒ–è·å–linkmapå€¼<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class InitUserSingleton &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(InitUserSingleton.class);</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisServiceI redisService;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public UserSingleton init()&#123;</span><br><span class="line">        LinkedHashMap&lt;String, String&gt; map = redisService.getMapValue(&quot;all&quot;);</span><br><span class="line">        return UserSingleton.setUserSingletonMap(map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»£ç è¯´æ˜ï¼š<br>æ³¨å…¥Beanï¼Œåœ¨Spingå¯åŠ¨æ—¶ï¼Œä»redisä¸­è·å–linkmapå€¼ï¼Œå¹¶å°†å€¼ä¼ å…¥å•ä¾‹ä¸­ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static UserSingleton setUserSingletonMap(LinkedHashMap&lt;String, String&gt; map)&#123;</span><br><span class="line">        if(userSingleton == null)&#123;</span><br><span class="line">            userSingleton = new UserSingleton();</span><br><span class="line">        &#125;</span><br><span class="line">        userSingleton.setLinkMap(map);</span><br><span class="line">        return userSingleton;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜ï¼šUserSingletonç±»æ–¹æ³•<br>è®¾ç½®linkmapå±æ€§å¯¹åº”çš„å€¼</p>
<p>å…­ã€æµ‹è¯•<br>æˆ‘é‡‡ç”¨çš„æ˜¯abæµ‹è¯•ï¼Œab -n 4 -c 1 <a href="http://localhost:8911/single/singleton?key=136ã€‚" target="_blank" rel="noopener">http://localhost:8911/single/singleton?key=136ã€‚</a><br>å››ä¸ªè¯·æ±‚åŒæ—¶å‘é€ï¼ŒæŸ¥çœ‹å•ä¾‹æ‰§è¡Œæƒ…å†µï¼Œå¤§å®¶ä¸‹è½½é¡¹ç›®ï¼Œç„¶åè¿è¡Œä»£ç ï¼Œå¯ä»¥çœ‹åˆ° logger.info(â€œin = inâ€);æ­¤å¤„ä¿¡æ¯åªæ‰“å°äº†ä¸€æ¬¡ï¼Œç”±æ­¤å¯ä»¥å¾—çŸ¥é™¤ç¬¬ä¸€æ¬¡è¯·æ±‚å¤–ï¼Œå‰©ä½™ä¸‰æ¬¡è¯·æ±‚éƒ½æ‹¿åˆ°valueï¼Œä»è€Œè¯´æ˜å››ä¸ªè¯·æ±‚çº¿ç¨‹ä¸ä¼šåŒæ—¶å»æ“ä½œå•ä¾‹å¯¹è±¡ï¼Œä¸”ä¿è¯äº†å¯¹è±¡çš„æ›´æ–°ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ­¤æ–¹æ¡ˆé€‚ç”¨äºç‹¬ç«‹çš„å¾®ä¿¡å…¬ä¼—å·å¼€å‘ï¼Œå½“å¼€å‘å¾®ä¿¡ç¬¬ä¸‰æ–¹å¹³å°æ—¶ï¼Œå¦‚æœç”¨æ­¤æ–¹æ¡ˆå­˜å‚¨å¤šä¸ªå•†å®¶çš„appIDå’Œå¯¹åº”çš„AccessTokenæ—¶ï¼Œåˆ™ä¼šå‡ºç°çº¿ç¨‹é˜»å¡ç­‰å¾…çš„æƒ…å†µï¼ŒåŸå› æ˜¯å•ä¾‹æ˜¯ç‹¬å çš„ï¼Œåœ¨å¾®ä¿¡ç¬¬ä¸‰æ–¹å¹³å°ç¯å¢ƒä¸‹ï¼Œå½“æœ‰å¤šä¸ªç”¨æˆ·åŒæ—¶è¿›å…¥å¤šä¸ªå¾®ä¿¡å…¬ä¼—å·ï¼Œç”±äºå•ä¾‹çš„ç‰¹æ€§ï¼Œä¼šå¯¼è‡´éƒ¨åˆ†çº¿ç¨‹å‡ºç°é˜»å¡ï¼Œæ— æ³•ç¬¬ä¸€æ—¶é—´è·å–åˆ°AccessTokenï¼Œå³ä½¿AccessTokenå­˜åœ¨äºlinkmapä¸­ã€‚<br>æ­¤ç¯‡ä¸­è¿˜æœ‰å‡ ä¸ªé—®é¢˜å¾…è§£å†³ï¼š<br>(1)ã€å¦‚ä½•è®¾ç½®å•ä¾‹å¯¹è±¡å±æ€§å€¼linkmapä¸­valueå€¼çš„è¿‡æœŸï¼Œæ­¤ç¯‡å¼€å¤´å°±æåˆ°é¢„è§£å†³çš„é—®é¢˜æ˜¯å¾®ä¿¡AccessToken7200ç§’å¤±æ•ˆåï¼Œè·å–æ–°çš„AccessTokenï¼Œä¸”ä¿è¯åªæœ‰å•ä¸€çº¿ç¨‹å»ä¿®æ”¹æ”¹å€¼ï¼Œè€Œä¸Šè¿°æ–¹æ¡ˆä¸­ï¼Œå¯ä»¥å®ç°å•ä¸€çº¿ç¨‹ä¿®æ”¹å€¼ï¼Œä½†æœªå»åˆ¤æ–­valueå€¼æ˜¯å¦è¿‡æœŸã€‚<br>(2)ã€æ­¤æ–¹æ¡ˆçš„å®æ–½ï¼Œå¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œè¿™ä¸ªè¿˜æœ‰å¾…ç ”ç©¶ã€‚</p>
<p>æˆ‘ä¼šåœ¨åç»­çš„æ–‡ç« ä¸­ï¼Œç»§ç»­è·Ÿè¿›ä¸Šè¿°æåˆ°çš„ç‚¹ã€‚æœ€åä¹Ÿæ˜¯ç‰¹åˆ«é‡è¦çš„ä¸€ç‚¹ï¼Œç«¥é‹ä»¬å¦‚æœæœ‰æ›´å¥½çš„ç†è§£å¯ä»¥åŠ æˆ‘å¾®ä¿¡ï¼šwjd632479475ï¼Œå¸Œæœ›èƒ½å’Œä½ è®¤è¯†ã€‚<br>é™„<a href="https://github.com/JiongJiongGe/BlogSingleton" target="_blank" rel="noopener">GitHubé¡¹ç›®é“¾æ¥åœ°å€</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/singleton/">singleton</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 äº‘å¼€
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>