<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>äºŒä¸ªæœˆåçš„é‡è§ï¼Œå€ŸåŠ©ShiroéªŒè¯è°ƒç”¨è€…çš„èº«ä»½åŠæƒé™ | å®ˆå¾—äº‘å¼€è§æœˆæ˜ | åœ¨ITæµ·æ´‹æ‰“æ»šçš„å°ğŸ³</title>

  
  <meta name="author" content="äº‘å¼€">
  

  
  <meta name="description" content="åœ¨ITæµ·æ´‹æ‰“æ»šçš„å°ğŸ³">
  

  
  
  <meta name="keywords" content="shiro">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="äºŒä¸ªæœˆåçš„é‡è§ï¼Œå€ŸåŠ©ShiroéªŒè¯è°ƒç”¨è€…çš„èº«ä»½åŠæƒé™"/>

  <meta property="og:site_name" content="å®ˆå¾—äº‘å¼€è§æœˆæ˜"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="å®ˆå¾—äº‘å¼€è§æœˆæ˜" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">å®ˆå¾—äº‘å¼€è§æœˆæ˜</a>
    </h1>
    <p class="site-description">åœ¨ITæµ·æ´‹æ‰“æ»šçš„å°ğŸ³</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">é¦–é¡µ</a></li>
      
        <li><a href="/about">å…³äº</a></li>
      
        <li><a href="/archives">å½’æ¡£</a></li>
      
        <li><a href="/tags">æ ‡ç­¾</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>äºŒä¸ªæœˆåçš„é‡è§ï¼Œå€ŸåŠ©ShiroéªŒè¯è°ƒç”¨è€…çš„èº«ä»½åŠæƒé™</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/06/09/yunkai_shiro/" rel="bookmark">
        <time class="entry-date published" datetime="2018-06-09T01:35:20.000Z">
          2018-06-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h2><p>åœ¨å®é™…çš„è½¯ä»¶å¼€å‘ä¸­ï¼Œå‡ºäºå®‰å…¨æ€§çš„è€ƒè™‘ï¼Œå¾€å¾€éœ€è¦å¯¹è®¿é—®è€…è®¿é—®çš„é¡µé¢ã€æ¥å£åšæƒé™ç®¡ç†ã€‚å¦‚æœä»åŠŸèƒ½ä¸Šæ¥è®²ï¼Œå®‰å…¨æ€§çš„å®šä¹‰å°±æ˜¯è®¿é—®è€…æ˜¯ä»¥æ­£ç¡®çš„æ–¹å¼è¯·æ±‚èµ„æºï¼Œå› æ­¤æˆ‘æŠŠæ—¥å¸¸åŠŸèƒ½åˆ†ä¸ºæ™®é€šåŠŸèƒ½å’Œç‰¹å®šåŠŸèƒ½(è¿™ä¸¤ä¸ªåè¯ä»…ä»…æ˜¯ä¸ªäººçš„æƒ³æ³•ğŸ˜Š)ã€‚æ‰€è°“çš„æ™®é€šåŠŸèƒ½ï¼Œä»æ™®é€šä¸¤ä¸ªå­—å°±èƒ½è§£è¯»å‡ºå¤§æ¦‚çš„æ„æ€ï¼Œå°±æ˜¯å…è®¸æ‰€æœ‰ç”¨æˆ·æ“ä½œï¼Œè€Œç‰¹å®šåŠŸèƒ½ï¼Œåˆ™éœ€è¦ç”¨æˆ·å…·å¤‡æŸç§ç‰¹å®šèº«ä»½æ‰èƒ½æ“ä½œã€‚å½“ç„¶å®ç°æƒé™æ§åˆ¶çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œ<br>ä¾‹å¦‚ï¼š</p>
<ul>
<li>AOP+Filterå®ç°</li>
<li>Spring Security</li>
<li>etcâ€¦</li>
</ul>
<p>è¯´å®Œäº†åº”ç”¨åœºæ™¯ï¼Œä¹Ÿåˆ—ä¸¾äº†å‡ ä¸ªå®ç°æƒé™æ§åˆ¶çš„æ–¹å¼ï¼Œä¸è¿‡ç›¸ä¿¡å¤§å®¶ä»æ ‡é¢˜ä¸­å°±èƒ½çŸ¥é“æœ¬ç¯‡è®²çš„åº”è¯¥æ˜¯å¦å¤–ä¸€ç§å®ç°æƒé™æ§åˆ¶çš„æ–¹å¼ï¼šShiroï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è®©æˆ‘ä»‹ç»ä¸‹åœ¨æ­¤ç¯‡ä¸­çš„ä¸»äººå…¬ã€‚</p>
<a id="more"></a>
<h2 id="Shiroä»‹ç»"><a href="#Shiroä»‹ç»" class="headerlink" title="Shiroä»‹ç»"></a>Shiroä»‹ç»</h2><p>Apache Shiro æ˜¯ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„å¼€å…ƒå®‰å…¨æ¡†æ¶ï¼Œç®€å•è½»ä¾¿åœ°å®ç°äº†ç”¨æˆ·è®¤è¯ã€æˆæƒã€ä¼ä¸šä¼šè¯ç®¡ç†å’ŒåŠ å¯†ã€‚å½“ç„¶ï¼Œè¿™ä»‹ç»æœ‰äº›å®˜ç½‘ï¼Œè¯´è¯´æˆ‘ä¸ªäººçš„ç†è§£å§ï¼Œæˆ‘ä¸ªäººè§‰å¾—Shiroèƒ½å¤Ÿæä¾›ä¸€å¥—å®Œæ•´çš„æƒé™æ§åˆ¶æ–¹æ¡ˆï¼Œä½¿å¾—æˆ‘åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸éœ€è¦å€ŸåŠ©å…¶ä»–çš„jaråŒ…æˆ–è€…APIç±»ã€‚</p>
<h2 id="æœ¬ç¯‡é¡¹ç›®å¯¹Shiroå®ç°çš„æ€è·¯"><a href="#æœ¬ç¯‡é¡¹ç›®å¯¹Shiroå®ç°çš„æ€è·¯" class="headerlink" title="æœ¬ç¯‡é¡¹ç›®å¯¹Shiroå®ç°çš„æ€è·¯"></a>æœ¬ç¯‡é¡¹ç›®å¯¹Shiroå®ç°çš„æ€è·¯</h2><h4 id="å…ˆè¯´ä¸€ä¸‹æˆ‘æƒ³å€ŸåŠ©Shiroæ¥å®ç°æ€æ ·çš„åŠŸèƒ½éœ€æ±‚ï¼š"><a href="#å…ˆè¯´ä¸€ä¸‹æˆ‘æƒ³å€ŸåŠ©Shiroæ¥å®ç°æ€æ ·çš„åŠŸèƒ½éœ€æ±‚ï¼š" class="headerlink" title="å…ˆè¯´ä¸€ä¸‹æˆ‘æƒ³å€ŸåŠ©Shiroæ¥å®ç°æ€æ ·çš„åŠŸèƒ½éœ€æ±‚ï¼š"></a>å…ˆè¯´ä¸€ä¸‹æˆ‘æƒ³å€ŸåŠ©Shiroæ¥å®ç°æ€æ ·çš„åŠŸèƒ½éœ€æ±‚ï¼š</h4><h5 id="éœ€æ±‚ä¸€ï¼š"><a href="#éœ€æ±‚ä¸€ï¼š" class="headerlink" title="éœ€æ±‚ä¸€ï¼š"></a>éœ€æ±‚ä¸€ï¼š</h5><p>éœ€è¦åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œå¦‚æœæœªç™»å½•ï¼Œæç¤ºç™»å½•ã€‚åœ¨æ­¤é€»è¾‘ä¸­ï¼Œç”±äºå‰åç«¯åˆ†ç¦»çš„æ¡†æ¶ï¼Œå¦‚æœç”¨æˆ·ç¬¬ä¸€æ¬¡ç™»å½•æˆåŠŸåï¼Œå‰ç«¯ä¼šåœ¨æœ¬åœ°æ•°æ®åº“ä¸­ä¿å­˜ä¸€ä¸ªX_userTokenå€¼(ä¿å­˜ç€ç”¨æˆ·çš„ä¿¡æ¯)ï¼Œå¦‚æœæ­¤å€¼å®‰å…¨ï¼Œå¹¶ä¸”æ˜¯Shiroä¸­sessionè®¤è¯ä¿¡æ¯è¿‡æœŸçš„æƒ…å†µä¸‹ï¼Œåˆ™ä¼šé»˜è®¤ä¸ºç™»å½•(é»˜è®¤æ“ä½œåœ¨æœåŠ¡ç«¯å®ç°ï¼Œç¨åä¼šé‡ç‚¹æåˆ°)ã€‚</p>
<h5 id="éœ€æ±‚äºŒï¼š"><a href="#éœ€æ±‚äºŒï¼š" class="headerlink" title="éœ€æ±‚äºŒï¼š"></a>éœ€æ±‚äºŒï¼š</h5><p>åœ¨ç”¨æˆ·å·²ç»ç™»å½•çš„æƒ…å†µä¸‹ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä»¥æ­£ç¡®çš„æ–¹å¼è¯·æ±‚èµ„æºï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç»™å‡ºå¯¹åº”æç¤ºã€‚</p>
<h5 id="è§£å†³æ€è·¯ï¼š"><a href="#è§£å†³æ€è·¯ï¼š" class="headerlink" title="è§£å†³æ€è·¯ï¼š"></a>è§£å†³æ€è·¯ï¼š</h5><p><img src="http://obbgpy87z.bkt.clouddn.com/blog_shiro.png" alt="è§£å†³æ€è·¯"></p>
<h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><h4 id="ä¸€ã€æ·»åŠ Shiroæ‰€éœ€çš„mavenä¾èµ–"><a href="#ä¸€ã€æ·»åŠ Shiroæ‰€éœ€çš„mavenä¾èµ–" class="headerlink" title="ä¸€ã€æ·»åŠ Shiroæ‰€éœ€çš„mavenä¾èµ–"></a>ä¸€ã€æ·»åŠ Shiroæ‰€éœ€çš„mavenä¾èµ–</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	 &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h4 id="äºŒã€Shiroç›¸å…³"><a href="#äºŒã€Shiroç›¸å…³" class="headerlink" title="äºŒã€Shiroç›¸å…³"></a>äºŒã€Shiroç›¸å…³</h4><h5 id="ShiroConfigé…ç½®"><a href="#ShiroConfigé…ç½®" class="headerlink" title="ShiroConfigé…ç½®"></a>ShiroConfigé…ç½®</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class ShiroConfig &#123;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * ShiroFilterFactoryBean å®ä¾‹</span><br><span class="line">	 * @param securityManager</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public ShiroFilterFactoryBean shirFilter(SecurityManager securityManager) &#123;</span><br><span class="line">		ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();</span><br><span class="line">		shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">		/**</span><br><span class="line">		 * æ‹¦æˆªå™¨ï¼Œé…ç½®ä¸ä¼šè¢«shiroæ‹¦æˆªçš„è·¯å¾„</span><br><span class="line">		 */</span><br><span class="line">		Map&lt;String,String&gt; filterChainDefinitionMap = new LinkedHashMap&lt;String,String&gt;();</span><br><span class="line">		Map&lt;String, Filter&gt; filters = new LinkedHashMap&lt;&gt;();</span><br><span class="line">		filters.put(&quot;authc&quot;, getCustomAccessFilter());</span><br><span class="line">		filterChainDefinitionMap.put(&quot;/shiro/filer&quot;, &quot;anon&quot;);</span><br><span class="line">		filterChainDefinitionMap.put(&quot;/logout&quot;, &quot;logout&quot;);</span><br><span class="line">		filterChainDefinitionMap.put(&quot;/**&quot;, &quot;authc&quot;);</span><br><span class="line">		shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">		/**</span><br><span class="line">		 * é…ç½®æœªéªŒè¯æˆåŠŸè·³è½¬çš„è·¯å¾„</span><br><span class="line">		 */</span><br><span class="line">		shiroFilterFactoryBean.setLoginUrl(&quot;/login&quot;);</span><br><span class="line">		shiroFilterFactoryBean.setFilters(filters);</span><br><span class="line">		return shiroFilterFactoryBean;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * é…ç½®å®‰å…¨æ•°æ®æºï¼Œshiroä»æ•°æ®åº“ä¸­è·å–å®‰å…¨æ•°æ®(ç”¨æˆ·ã€è§’è‰²ã€æƒé™)</span><br><span class="line">	 *</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public ShiroRealm shiroRealm()&#123;</span><br><span class="line">		ShiroRealm shiroRealm = new ShiroRealm();</span><br><span class="line">		return shiroRealm;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    /**</span><br><span class="line">	 * è‡ªå®šä¹‰è¿‡æ»¤å™¨</span><br><span class="line">	 *</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public ShiroCustomAccessFilter getCustomAccessFilter()&#123;</span><br><span class="line">		return new ShiroCustomAccessFilter();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * é…ç½®securityManager,é€šè¿‡Realmè·å–ç›¸åº”çš„ç”¨æˆ·èº«ä»½ç¡®è®¤åˆæ³•æ€§</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public SecurityManager securityManager()&#123;</span><br><span class="line">		DefaultWebSecurityManager securityManager =  new DefaultWebSecurityManager();</span><br><span class="line">		securityManager.setRealm(shiroRealm());</span><br><span class="line">		return securityManager;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * å¼€å¯shiro aopæ³¨è§£æ”¯æŒ.</span><br><span class="line">	 * ä½¿ç”¨ä»£ç†æ–¹å¼;æ‰€ä»¥éœ€è¦å¼€å¯ä»£ç æ”¯æŒ;</span><br><span class="line">	 * @param securityManager</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(SecurityManager securityManager)&#123;</span><br><span class="line">		AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = new AuthorizationAttributeSourceAdvisor();</span><br><span class="line">		authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span><br><span class="line">		return authorizationAttributeSourceAdvisor;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜ï¼š<br>1ã€ShiroFilterFactoryBeanä½œä¸ºä¸€ä¸ªå·¥å‚Beanï¼Œå°†Shiroå®ä¾‹å¯¹è±¡æ³¨å…¥åˆ°Springå®¹å™¨ä¸­ï¼ŒåŒæ—¶å¯ä»¥è®¾ç½®å®‰å…¨ç®¡ç†å™¨(securityManager)ã€æ‹¦æˆªå™¨(filterChainDefinitionMapã€filters)ã€é…ç½®æœªæˆåŠŸç™»å½•è·³è½¬ä¿¡æ¯ç­‰å±æ€§ï¼Œè¿™æ ·Shiroå°±å¯ä»¥åŸºäºurlçš„æ–¹å¼è¿›è¡Œè¯·æ±‚è¿‡æ»¤å¤„ç†ã€‚<br>2ã€shiroRealm()æ–¹æ³•ï¼Œé…ç½®å®‰å…¨æ•°æ®æº,åœ¨ShiroRealmç±»ä¸­ï¼Œä¼šéªŒè¯ç”¨æˆ·æ˜¯å¦è®¤è¯ä¸”ä¼šè·å–åˆ°ç”¨æˆ·çš„æƒé™ï¼Œå¹¶å°†æƒé™é›†æ”¾å…¥Shiroä¸­ã€‚<br>3ã€securityManager()æ–¹æ³•ï¼Œå³é…ç½®å®‰å…¨ç®¡ç†å™¨ï¼Œä»¥å®æ–½åº”ç”¨æ‰€éœ€çš„å®‰å…¨ç­–ç•¥ï¼Œå³å®æ–½ShiroRealmç±»ä¸­çš„ç­–ç•¥ã€‚<br>4ã€getCustomAccessFilter()æ–¹æ³•ï¼Œè‡ªå®šä¹‰è¿‡æ»¤å™¨ã€‚<br>æ¥ä¸‹æ¥ä¼šé‡ç‚¹è®²ShiroRealmç±»å’ŒShiroCustomAccessFilterç±»</p>
<h5 id="ShiroCustomMatcher-è‡ªå®šä¹‰Matcher-å¯†ç åŒ¹é…è¿‡ç¨‹"><a href="#ShiroCustomMatcher-è‡ªå®šä¹‰Matcher-å¯†ç åŒ¹é…è¿‡ç¨‹" class="headerlink" title="ShiroCustomMatcher è‡ªå®šä¹‰Matcher(å¯†ç åŒ¹é…è¿‡ç¨‹)"></a>ShiroCustomMatcher è‡ªå®šä¹‰Matcher(å¯†ç åŒ¹é…è¿‡ç¨‹)</h5><p>å› ä¸ºéªŒè¯ç”¨æˆ·æ˜¯å¦åˆæ³•æ˜¯å€ŸåŠ©äºX_userTokençš„æ–¹å¼ï¼Œæ— éœ€è¿›è¡Œå¯†ç ç™»å½•ï¼Œæ•…åœ¨æ­¤æ–¹æ¡ˆä¸­ï¼Œæˆ‘é‡‡ç”¨çš„æ˜¯Shiroå…å¯†ç™»å½•çš„æ“ä½œã€‚(Shioråœ¨æˆ‘çš„å®é™…å¼€å‘é¡¹ç›®ä¸­X_userTokençš„å€¼æ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹å¹³å°è¿”å›ï¼Œå¦‚æœæ˜¯å¯†ç ç™»å½•é¡¹ç›®ä¸­ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆå¯¹åº”çš„X_userToken)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public enum ShiroLoginType &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 1ã€éœ€è¦å¯†ç éªŒè¯ç™»é™†;2ã€æ— éœ€å¯†ç éªŒè¯ç™»é™†</span><br><span class="line">     */</span><br><span class="line">    PASSWORD(1),</span><br><span class="line">    NOPASSWORD(2);</span><br><span class="line"></span><br><span class="line">    private int code;</span><br><span class="line"></span><br><span class="line">    ShiroLoginType(int code) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getCode() &#123;</span><br><span class="line">        return code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCode(int code) &#123;</span><br><span class="line">        this.code = code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * shiroè‡ªå®šä¹‰ç”¨æˆ·å¯†ç token</span><br><span class="line">  */</span><br><span class="line">public class ShiroCustomToken extends UsernamePasswordToken &#123;</span><br><span class="line"></span><br><span class="line">    private ShiroLoginType type;   //æ˜¯å¦éœ€è¦å¯†ç ç™»å½•ç±»å‹</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public ShiroCustomToken(String userName, String password, ShiroLoginType type) &#123;</span><br><span class="line">        super(userName, password);</span><br><span class="line">        this.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public ShiroLoginType getType() &#123;</span><br><span class="line">        return type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setType(ShiroLoginType type) &#123;</span><br><span class="line">        this.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class ShiroCustomMatcher extends HashedCredentialsMatcher &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean doCredentialsMatch(AuthenticationToken token, AuthenticationInfo info) &#123;</span><br><span class="line">        ShiroCustomToken customToken = (ShiroCustomToken) token;</span><br><span class="line">        //å¦‚æœè®¾ç½®æ— éœ€å¯†ç éªŒè¯ï¼Œåˆ™ç›´æ¥è¿”å›trueå€¼</span><br><span class="line">        if(customToken.getType() == ShiroLoginType.NOPASSWORD)&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼š<br>1ã€ShiroCustomTokenç»§æ‰¿äº†UsernamePasswordTokenç±»ï¼Œå¹¶å¢åŠ typeå±æ€§ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦å¯†ç ç™»å½•<br>2ã€åœ¨ShiroCustomMatcherç±»ä¸­ï¼Œé€šè¿‡AuthenticationTokenç±»è·å–åˆ°ShiroCustomTokenå¯¹è±¡ï¼Œå¦‚æœå¯¹åº”çš„typeç±»å‹ä¸ºNOPASSWORDï¼Œåˆ™è¿”å›trueè¡¨ç¤ºå…å¯†ç™»å½•ã€‚</p>
<h5 id="ShirlRealmç±»"><a href="#ShirlRealmç±»" class="headerlink" title="ShirlRealmç±»"></a>ShirlRealmç±»</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * æˆæƒæƒé™éªŒè¯</span><br><span class="line">  *</span><br><span class="line">  * @param principals</span><br><span class="line">  * @return</span><br><span class="line">  */</span><br><span class="line"> @Override</span><br><span class="line"> protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) &#123;</span><br><span class="line">     SimpleAuthorizationInfo authorizationInfo = new SimpleAuthorizationInfo();</span><br><span class="line">     try &#123;</span><br><span class="line">         UserDo userDo = (UserDo) principals.getPrimaryPrincipal();</span><br><span class="line">         //è·å–ç”¨æˆ·è§’è‰²å…³ç³»</span><br><span class="line">         List&lt;UserRoleDo&gt; userRoleDos = userRoleService.getByUserId(userDo.getId());</span><br><span class="line">         List&lt;Integer&gt; roleIds = new ArrayList&lt;Integer&gt;();</span><br><span class="line">         if (!CollectionUtils.isEmpty(userRoleDos)) &#123;</span><br><span class="line">             for (UserRoleDo userRoleDo : userRoleDos) &#123;</span><br><span class="line">                 roleIds.add(userRoleDo.getRoleId());</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         //è·å–ç”¨æˆ·è§’è‰²ä¿¡æ¯</span><br><span class="line">         List&lt;RoleDo&gt; roleDos = roleService.findList(roleIds);</span><br><span class="line">         if (!CollectionUtils.isEmpty(roleDos)) &#123;</span><br><span class="line">             for (RoleDo roleDo : roleDos) &#123;</span><br><span class="line">                 authorizationInfo.addRole(roleDo.getRole());</span><br><span class="line">                 //è·å–è§’è‰²æƒé™</span><br><span class="line">                 List&lt;RolePermissionDo&gt; rolePermissionDos = rolePermissionService.findByRoleId(roleDo.getId());</span><br><span class="line">                 List&lt;Integer&gt; rpIds = new ArrayList&lt;Integer&gt;();</span><br><span class="line">                 if (!CollectionUtils.isEmpty(rolePermissionDos)) &#123;</span><br><span class="line">                     for (RolePermissionDo rolePermissionDo : rolePermissionDos) &#123;</span><br><span class="line">                         rpIds.add(rolePermissionDo.getPermissId());</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 List&lt;PermissionDo&gt; permissionDos = permissionService.findList(rpIds);</span><br><span class="line">                 if (!CollectionUtils.isEmpty(permissionDos)) &#123;</span><br><span class="line">                     for (PermissionDo permissionDo : permissionDos) &#123;</span><br><span class="line">                         authorizationInfo.addStringPermission(permissionDo.getPermissionMessage());</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;catch (Exception e)&#123;</span><br><span class="line">         logger.error(&quot;doGetAuthorizationInfo error = &#123;&#125;&quot;, e);</span><br><span class="line">     &#125;</span><br><span class="line">     return authorizationInfo;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * éªŒè¯ç”¨æˆ·æ˜¯å¦è®¤è¯</span><br><span class="line">  * @param token</span><br><span class="line">  * @return</span><br><span class="line">  * @throws AuthenticationException</span><br><span class="line">  */</span><br><span class="line"> @Override</span><br><span class="line"> protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token)</span><br><span class="line">         throws AuthenticationException &#123;</span><br><span class="line">     //è·å–ä¼ å…¥çš„ç”¨æˆ·ID.</span><br><span class="line">     String userID = (String)token.getPrincipal();</span><br><span class="line">     //æ ¹æ®ç”¨æˆ·IDè·å–å¯¹è±¡ï¼Œè‹¥å­˜åœ¨ã€‚åˆ™éªŒè¯æˆåŠŸ</span><br><span class="line">     UserDo userDo = userService.getByID(userID);</span><br><span class="line">     if(userDo == null)&#123;</span><br><span class="line">         return null;</span><br><span class="line">     &#125;</span><br><span class="line">     SimpleAuthenticationInfo authenticationInfo = new SimpleAuthenticationInfo(userDo, &quot;&quot;, getName());</span><br><span class="line">     return authenticationInfo;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜ï¼š<br>1ã€doGetAuthorizationInfo()éªŒè¯ç”¨æˆ·æ˜¯å¦å…·å¤‡è¯·æ±‚è¯¥èµ„æºçš„æƒé™ã€‚<br>2ã€doGetAuthenticationInfo()æ–¹æ³•åˆ™éªŒè¯ç”¨æˆ·æ˜¯å¦è®¤è¯ã€‚</p>
<h5 id="ShiroCustomAccessFilterè‡ªå®šä¹‰è¿‡æ»¤å™¨"><a href="#ShiroCustomAccessFilterè‡ªå®šä¹‰è¿‡æ»¤å™¨" class="headerlink" title="ShiroCustomAccessFilterè‡ªå®šä¹‰è¿‡æ»¤å™¨"></a>ShiroCustomAccessFilterè‡ªå®šä¹‰è¿‡æ»¤å™¨</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @Intro: è‡ªå®šä¹‰åˆ¤æ–­æƒé™filter</span><br><span class="line"> * @Author: WangJiongDa(yunkai)</span><br><span class="line"> * @Date: 2018/6/1</span><br><span class="line"> * @Time: ä¸‹åˆ4:55</span><br><span class="line"> */</span><br><span class="line">public class ShiroCustomAccessFilter extends AccessControlFilter &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(ShiroCustomAccessFilter.class);</span><br><span class="line"></span><br><span class="line">    private String loginUrl = &quot;/login&quot;;</span><br><span class="line"></span><br><span class="line">    private static final String noPermissUrl = &quot;/no/permission&quot;;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private PermissionService permissionService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isAccessAllowed(ServletRequest servletRequest, ServletResponse servletResponse, Object o) throws Exception &#123;</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        if(loginUrl.equals(getPathWithinApplication(servletRequest)) || (noPermissUrl.equals(getPathWithinApplication(servletRequest))) || checkPermission(servletRequest, subject))&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean onAccessDenied(ServletRequest servletRequest, ServletResponse servletResponse) throws Exception &#123;</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        HttpServletRequest httpRequest = WebUtils.toHttp(servletRequest);</span><br><span class="line">        if(!subject.isAuthenticated() &amp;&amp; !pathsMatch(loginUrl, servletRequest))&#123;</span><br><span class="line">            Session session = subject.getSession();</span><br><span class="line">            Map&lt;String, Object&gt; reqParams = new HashMap&lt;String, Object&gt;();</span><br><span class="line">            Enumeration em = httpRequest.getParameterNames();</span><br><span class="line">            //è·å–postè¯·æ±‚bodyä¸­è¯·æ±‚çš„å‚æ•°</span><br><span class="line">            while (em.hasMoreElements()) &#123;</span><br><span class="line">                String name = (String) em.nextElement();</span><br><span class="line">                String value = httpRequest.getParameter(name);</span><br><span class="line">                reqParams.put(name, value);</span><br><span class="line">            &#125;</span><br><span class="line">            SavedRequestBean savedRequestBean = new SavedRequestBean(httpRequest, reqParams);</span><br><span class="line">            session.setAttribute(&quot;savedRequestBean&quot;, savedRequestBean);</span><br><span class="line">            saveRequestAndRedirectToLogin(servletRequest, servletResponse);</span><br><span class="line">        &#125; else&#123;</span><br><span class="line"></span><br><span class="line">            if(!checkPermission(servletRequest, subject))&#123;</span><br><span class="line">                WebUtils.issueRedirect(servletRequest, servletResponse, noPermissUrl);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * éªŒè¯ç”¨æˆ·æƒé™</span><br><span class="line">     *</span><br><span class="line">     * @param servletRequest</span><br><span class="line">     * @param subject</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private boolean checkPermission(ServletRequest servletRequest, Subject subject)&#123;</span><br><span class="line">        HttpServletRequest request = WebUtils.toHttp(servletRequest);</span><br><span class="line">        String actionUrl = WebUtils.getRequestUri(request);</span><br><span class="line">        PermissionDo permission = permissionService.getByUrl(actionUrl);</span><br><span class="line">        if(subject.isPermitted(permission.getPermissionMessage()))&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜ï¼š<br>ShiroCustomAccessFilterç»§æ‰¿äº†AccessControlFilteræŠ½è±¡ç±»ï¼Œå¹¶é‡å†™äº†isAccessAllowed()å’ŒonAccessDenied()æ–¹æ³•ã€‚<br>1ã€isAccessAllowed()æ–¹æ³•å†…ä¼šåˆ¤æ–­æ˜¯å¦å…è®¸è®¿é—®ï¼Œtrueè¡¨ç¤ºå…è®¸è®¿é—®ï¼Œfalseåˆ™ä¸å…è®¸è®¿é—®ã€‚åœ¨å®ç°ä¸­ï¼Œå½“è¯·æ±‚è·¯å¾„ä¸º/loginã€/no/permissionå’Œç”¨æˆ·æ‹¥æœ‰è®¿é—®æ­¤é“¾æ¥çš„æƒé™æ—¶ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚<br>2ã€onAccessDenied()æ–¹æ³•åˆ™ä¼šå½“isAccessAllowed()æ”¾å›falseæ—¶ï¼Œåšè‡ªå®šä¹‰å¤„ç†ã€‚åœ¨å®ç°ä¸­ï¼Œå½“ç”¨æˆ·æœªç™»å½•æ—¶ï¼Œä¼šè°ƒç”¨saveRequestAndRedirectToLogin()æ–¹æ³•ï¼Œè·³è½¬åˆ°/loginè¯·æ±‚ä¸­(ä¹‹åä¼šè®²åˆ°loginçš„å¤„ç†)ï¼Œå½“ç”¨æˆ·æƒé™ä¸è¶³æ—¶ï¼Œä¼šè·³è½¬åˆ°/no/permissionä¸­ï¼Œæç¤ºæƒé™ä¸è¶³ã€‚å…¶ä»–åˆ™è¿”å›falseï¼Œä¸åšä»»ä½•å¤„ç†ã€‚åŒæ—¶ï¼Œä¼šåœ¨æ­¤æ–¹æ³•ä¸­ï¼Œè®°å½•ç”¨æˆ·åœ¨æœªç™»å½•çš„æƒ…å†µä¸‹è¯·æ±‚çš„é“¾æ¥å’Œå‚æ•°ã€‚<br>3ã€checkPermission()æ–¹æ³•åˆ™æ˜¯ç§æœ‰æ–¹æ³•ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æ­¤è¯·æ±‚çš„æƒé™ã€‚<br>4ã€subject.isPermitted()æ–¹æ³•åœ¨éªŒè¯æƒé™æ—¶ï¼Œä¼šè°ƒç”¨ShiroRelamç±»ä¸­çš„doGetAuthorizationInfo()æ–¹æ³•å»éªŒè¯æƒé™ã€‚</p>
<h5 id="BaseControllerã€LoginControllerã€PermissionController"><a href="#BaseControllerã€LoginControllerã€PermissionController" class="headerlink" title="BaseControllerã€LoginControllerã€PermissionController"></a>BaseControllerã€LoginControllerã€PermissionController</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public class BaseController &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(BaseController.class);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è·å–request bodyä¸­çš„å‚æ•°ï¼Œå¦‚æœé€šè¿‡shiroé‡ç™»å½•ï¼Œåˆ™ä»ä¸Šä¸€ä¸ªè¯·æ±‚ä¸­è·å–</span><br><span class="line">     *</span><br><span class="line">     * @param request</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    protected Map&lt;String, Object&gt; getRequestParams(HttpServletRequest request)&#123;</span><br><span class="line">        Map&lt;String, Object&gt; reqParams = new HashMap&lt;String, Object&gt;();</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        Session session = subject.getSession();</span><br><span class="line">        SavedRequestBean savedRequestBean = (SavedRequestBean) session.getAttribute(&quot;savedRequestBean&quot;);</span><br><span class="line">        if(savedRequestBean != null)&#123;</span><br><span class="line">            reqParams = savedRequestBean.getParams();</span><br><span class="line">            session.removeAttribute(&quot;savedRequestBean&quot;);</span><br><span class="line">        &#125; else&#123;</span><br><span class="line">            Enumeration em = request.getParameterNames();</span><br><span class="line">            //è·å–postè¯·æ±‚bodyä¸­è¯·æ±‚çš„å‚æ•°</span><br><span class="line">            while (em.hasMoreElements()) &#123;</span><br><span class="line">                String name = (String) em.nextElement();</span><br><span class="line">                String value = request.getParameter(name);</span><br><span class="line">                reqParams.put(name, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return reqParams;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è·å–ç™»å½•ç”¨æˆ·ID</span><br><span class="line">     *</span><br><span class="line">     * @param request</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    protected Integer getUserId(HttpServletRequest request)&#123;</span><br><span class="line">        Integer userID = (Integer) request.getAttribute(&quot;userID&quot;);</span><br><span class="line">        return userID;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜ï¼š<br>getRequestParams()æ–¹æ³•ä¼šè·å–ç”¨æˆ·è¯·æ±‚çš„å‚æ•°ï¼ŒåŒæ—¶åœ¨æ­¤æ–¹æ³•ä¸­ä¼šåˆ¤æ–­ï¼Œè¯·æ±‚æ˜¯å¦èµ°äº†ä»¥ä¸‹çš„æµç¨‹ï¼šè¯·æ±‚A(æœªç™»å½•)-&gt;/login-&gt;è¯·æ±‚Aä¸­ï¼Œå¦‚æœæ˜¯è¿™æ ·ï¼Œä¼šä»subjectçš„sessionä¸­è·å–ä¹‹å‰åœ¨onAccessDenied()æ–¹æ³•ä¸­ä¿å­˜çš„å‚æ•°ä¿¡æ¯ã€‚<br>getUserId()æ–¹æ³•æ˜¯ä»æ‹¦æˆªå™¨ä¸­è·å–åˆ°requestä¸­çš„userIDä¿¡æ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class LoginController extends BaseController&#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(LoginController.class);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * é€šè¿‡ä½¿ç”¨ç”¨æˆ·çš„tokenï¼Œè¿›è¡Œshiroç™»é™†</span><br><span class="line">     *</span><br><span class="line">     * @param servletRequest</span><br><span class="line">     * @param servletResponse</span><br><span class="line">     * @return</span><br><span class="line">     * @throws IOException</span><br><span class="line">     */</span><br><span class="line">    @RequestMapping(&quot;/login&quot;)</span><br><span class="line">    public RpcResult&lt;Boolean&gt; login(ServletRequest servletRequest, ServletResponse servletResponse) throws IOException &#123;</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        SavedRequest sr = WebUtils.getSavedRequest(servletRequest);</span><br><span class="line">        HttpServletRequest request = WebUtils.toHttp(servletRequest);</span><br><span class="line">        String X_userToken = request.getHeader(&quot;X_userToken&quot;);</span><br><span class="line">        Integer userID = ParseTokenUtil.parse(X_userToken);</span><br><span class="line">        if(!subject.isAuthenticated()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                ShiroCustomToken token = new ShiroCustomToken(userID + &quot;&quot;, &quot;&quot;, ShiroLoginType.NOPASSWORD);</span><br><span class="line">                subject.login(token);</span><br><span class="line">            &#125;catch (Exception e)&#123;</span><br><span class="line">                logger.error(&quot;error = &#123;&#125;&quot;, e.getMessage());</span><br><span class="line">                return RpcResult.ofError(ErrorCode.BIZ_ERROR.getCode(), ErrorCode.BIZ_ERROR.getMsg(&quot;shiroéªŒè¯å¤±è´¥&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        WebUtils.issueRedirect(servletRequest, servletResponse, sr.getRequestUrl());</span><br><span class="line">        return RpcResult.ofSuccess(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜ï¼š<br>ä¹‹å‰æœ‰æåˆ°ï¼Œå¦‚æœX_userTokenå®‰å…¨ï¼Œå¹¶ä¸”æ˜¯Shiroä¸­sessionè®¤è¯ä¿¡æ¯è¿‡æœŸçš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡ç«¯ä¼šåšShiroç™»å½•å¤„ç†ï¼Œè°ƒç”¨subject.login(token)æ–¹æ³•ï¼Œä½¿ç”¨è‡ªå®šä¹‰ShiroCustomTokenå…ç™»tokenï¼Œå¸®åŠ©ç”¨æˆ·æ— æ„ŸçŸ¥çš„å®Œæˆç™»å½•ï¼Œæ— éœ€ç”¨æˆ·é‡æ–°è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚å½“ç„¶ï¼Œå¦‚æœç”¨æˆ·éªŒè¯å¤±è´¥ï¼Œåˆ™ä¼šåœ¨catchä¸­æ•è·åˆ°å¼‚å¸¸ï¼Œè¿”å›éªŒè¯å¤±è´¥çš„ä¿¡æ¯ï¼Œä¿¡æ¯è¿”å›ç»™å‰ç«¯ï¼Œå‰ç«¯åŒå­¦å¯ä»¥æ ¹æ®è¿”å›çš„ä¿¡æ¯åšç›¸å…³çš„åˆ¤æ–­é€»è¾‘ã€‚<br>subject.login()æ–¹æ³•æ‰§è¡Œåï¼Œä¼šè¿›å…¥åˆ°ShiroRealmä¸­çš„doGetAuthenticationInfo()æ–¹æ³•ï¼Œåœ¨doGetAuthenticationInfo()æ–¹æ³•ä¸­ï¼Œå¦‚æœuserIDèƒ½è·å–åˆ°userå¯¹è±¡ï¼Œåˆ™é»˜è®¤ç™»å½•æˆåŠŸã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class PermissionController extends BaseController&#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æƒé™ä¸è¶³</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @RequestMapping(&quot;/no/permission&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public RpcResult&lt;String&gt; noPermission()&#123;</span><br><span class="line">        return RpcResult.ofError(ErrorCode.BIZ_ERROR.getCode(), ErrorCode.BIZ_ERROR.getMsg(&quot;æƒé™ä¸è¶³&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è¯´æ˜ï¼š<br>è¿›å…¥æ­¤è¯·æ±‚åˆ™è¡¨ç¤ºç”¨æˆ·è®¿é—®çš„è¯·æ±‚æ²¡æœ‰å¯¹åº”çš„æƒé™ï¼Œä»è€Œè·³è½¬åˆ°æ­¤æ–¹æ³•ä¸­ã€‚</p>
<h4 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h4><p>1ã€é¡¹ç›®çš„å…ƒç´ æœ‰äº›ä¸°å¯Œï¼Œåœ¨æœ¬ç¯‡ä¸­ä¸èƒ½ä¸€ä¸€è¯´æ˜ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥å»gitHubä¸Šä¸‹è½½é¡¹ç›®æŸ¥çœ‹åˆ°æ‰€æœ‰çš„å®ç°ã€‚<br>2ã€å½“ç„¶æœ¬é¡¹ç›®è¿˜å­˜ç€ä¸€äº›å€¼å¾—ä¼˜åŒ–çš„åœ°æ–¹ï¼Œä¾‹å¦‚doGetAuthorizationInfo()æ–¹æ³•ä¸­è·å–æƒé™çš„æ–¹å¼ï¼Œå¯ä»¥å°†æƒé™é€šè¿‡Redisç¼“å­˜èµ·æ¥ï¼Œè€Œæ— éœ€æ¯æ¬¡ä»DBä¸­è·å–ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚å¦‚æœå€ŸåŠ©Redisï¼Œå½“ç”¨æˆ·æƒé™æ›´æ–°æ—¶ï¼Œå¿…é¡»è¦ç«‹å³æ›´æ–°Rediså†…çš„å€¼ä¿¡æ¯ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Shiroæ¡†æ¶çš„å®‰å…¨è®¤è¯åœ¨å®é™…çš„å¼€å‘ä¸­åº”ç”¨ä¹Ÿæ¯”è¾ƒæ™®éï¼Œå°ğŸ³åœ¨æ­¤ç¯‡ä¸­åªæ˜¯ä½¿ç”¨äº†åŸºæœ¬çš„æ–¹æ³•å®ç°è‡ªå·±å¼€å‘ä¸­æ‰€éœ€çš„åŠŸèƒ½ï¼Œå¸Œæœ›èƒ½ç»™å¤§å®¶ä¸€ä¸ªå…¥é—¨çš„æŒ‡å¼•ï¼Œå½“ç„¶å¦‚æœä½ ç”¨åˆ°äº†Shiroçš„å…¶ä»–åŠŸèƒ½æˆ–è€…æ¯”æˆ‘æ›´å¥½åœ°å®ç°ï¼Œå¯ä»¥ç»™æˆ‘ä¸€äº›å»ºè®®å“¦ã€‚æœ¬äººå¾®ä¿¡ï¼šwjd632479475ï¼Œå¸Œæœ›èƒ½å’Œä½ è®¤è¯†ã€‚å¤§å®¶ï¼Œä¸‹æ¬¡è§ã€‚</p>
<p>é™„<a href="https://github.com/JiongJiongGe/SpringBootShiro" target="_blank" rel="noopener">GitHubé¡¹ç›®é“¾æ¥åœ°å€</a></p>
<p>LINKSï¼š<br><a href="https://blog.csdn.net/xieliaowa9231/article/details/78996451" target="_blank" rel="noopener">SpringBootæ•´åˆShiroè‡ªå®šä¹‰è¿‡æ»¤å™¨</a><br><a href="http://blog.51cto.com/wyait/2107423" target="_blank" rel="noopener">Shiro AccessControlFilteræ–¹æ³•ä»‹ç»</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/shiro/">shiro</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 äº‘å¼€
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>