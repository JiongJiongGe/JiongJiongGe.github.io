<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ä½¿ç”¨Semaphoreä¿¡å·é‡ï¼Œæ¥æ§åˆ¶èµ„æºæ± çš„ä½¿ç”¨æƒ…å†µ | å®ˆå¾—äº‘å¼€è§æœˆæ˜ | åœ¨ITæµ·æ´‹æ‰“æ»šçš„å°ğŸ³</title>

  
  <meta name="author" content="äº‘å¼€">
  

  
  <meta name="description" content="åœ¨ITæµ·æ´‹æ‰“æ»šçš„å°ğŸ³">
  

  
  
  <meta name="keywords" content="Semaphore">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="ä½¿ç”¨Semaphoreä¿¡å·é‡ï¼Œæ¥æ§åˆ¶èµ„æºæ± çš„ä½¿ç”¨æƒ…å†µ"/>

  <meta property="og:site_name" content="å®ˆå¾—äº‘å¼€è§æœˆæ˜"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="å®ˆå¾—äº‘å¼€è§æœˆæ˜" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">å®ˆå¾—äº‘å¼€è§æœˆæ˜</a>
    </h1>
    <p class="site-description">åœ¨ITæµ·æ´‹æ‰“æ»šçš„å°ğŸ³</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">é¦–é¡µ</a></li>
      
        <li><a href="/about">å…³äº</a></li>
      
        <li><a href="/archives">å½’æ¡£</a></li>
      
        <li><a href="/tags">æ ‡ç­¾</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>ä½¿ç”¨Semaphoreä¿¡å·é‡ï¼Œæ¥æ§åˆ¶èµ„æºæ± çš„ä½¿ç”¨æƒ…å†µ</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/04/06/yunkai_semaphore/" rel="bookmark">
        <time class="entry-date published" datetime="2018-04-06T04:37:20.000Z">
          2018-04-06
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h2><p>åœ¨å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†æé«˜ç¨‹åºçš„å“åº”é€Ÿåº¦å’Œå“åº”æ•ˆç‡ç­‰ï¼Œå¾€å¾€ä¼šåˆå§‹åŒ–ä¸€äº›èµ„æºæ± ï¼Œæä¾›ç»™ç¨‹åºè°ƒç”¨ã€‚åœ¨æœ¬ç¯‡ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡Semaphoreä¿¡å·é‡ï¼Œæ¥æ§åˆ¶èµ„æºæ± å†…èµ„æºçš„ä½¿ç”¨æƒ…å†µï¼Œä¾‹å¦‚ï¼šèµ„æºçš„å ç”¨ã€é‡Šæ”¾ã€‚<br><a id="more"></a></p>
<h2 id="Semaphoreä»‹ç»"><a href="#Semaphoreä»‹ç»" class="headerlink" title="Semaphoreä»‹ç»"></a>Semaphoreä»‹ç»</h2><p>Semaphoreæ˜¯ä¸€ä¸ªçº¿ç¨‹åŒæ­¥çš„è¾…åŠ©ç±»ï¼Œå¯ä»¥ç»´æŠ¤å½“å‰è®¿é—®è‡ªèº«çš„çº¿ç¨‹ä¸ªæ•°ï¼Œå¹¶æä¾›äº†åŒæ­¥æœºåˆ¶ï¼Œä½¿ç”¨Semaphoreå¯ä»¥æ§åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„çº¿ç¨‹ä¸ªæ•°ã€‚Semaphoreé€šè¿‡acquire()å’Œrelease()æ–¹æ³•ï¼Œæ¥å®ç°è·å–å’Œé‡Šæ”¾è®¿é—®è®¸å¯ã€‚</p>
<h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><p>æ§åˆ¶èµ„æºæ± çš„ä½¿ç”¨æƒ…å†µï¼Œæœ‰å¾ˆå¤šç§æ–¹å¼ï¼ŒSemaphoreä¿¡å·é‡åªæ˜¯å…¶ä¸­ä¸€ç§å®ç°æ–¹å¼ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥æœ‰åˆ«çš„æ–¹å¼ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚</p>
<h4 id="ä¸€ã€æ„å»ºé¡¹ç›®"><a href="#ä¸€ã€æ„å»ºé¡¹ç›®" class="headerlink" title="ä¸€ã€æ„å»ºé¡¹ç›®"></a>ä¸€ã€æ„å»ºé¡¹ç›®</h4><p>æ„å»ºDomianã€Controllerå±‚ï¼Œç›¸ä¿¡ç«¥é‹çš„æ°´å¹³éƒ½æ˜¯æ£’æ£’çš„ï¼Œè¿™è¾¹å°±ä¸ä¸€ä¸€ç½—åˆ—å¯¹åº”çš„æ–¹æ³•ï¼Œåœ¨æœ¬ç¯‡ä¸­ä½¿ç”¨EnvRoomDo(æ•™å®¤ç±»)ï¼Œç”¨äºèµ„æºçš„å®šä¹‰ï¼Œå¹¶é€šè¿‡Controllerå±‚çš„æ–¹æ³•æ¨¡æ‹Ÿè¯·æ±‚ï¼Œå±•ç°ç»“æœã€‚</p>
<h4 id="äºŒã€åˆå§‹åŒ–ä¿¡å·é‡"><a href="#äºŒã€åˆå§‹åŒ–ä¿¡å·é‡" class="headerlink" title="äºŒã€åˆå§‹åŒ–ä¿¡å·é‡"></a>äºŒã€åˆå§‹åŒ–ä¿¡å·é‡</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public class SemaphoreConstant &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *  ä¿¡å·é‡(æ§åˆ¶èµ„æºæ± )</span><br><span class="line">     */</span><br><span class="line">    private Semaphore resouceRoomSemaphore;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *  ä¿¡å·é‡å¤§å°ï¼Œå³èµ„æºæ± çš„å¤§å°</span><br><span class="line">     */</span><br><span class="line">    private int semaphoreSize = 10;</span><br><span class="line"></span><br><span class="line">    public SemaphoreConstant()&#123;</span><br><span class="line">        resouceRoomSemaphore = new Semaphore(semaphoreSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Semaphore getResouceRoomSemaphore() &#123;</span><br><span class="line">        return resouceRoomSemaphore;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getSemaphoreSize() &#123;</span><br><span class="line">        return semaphoreSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSemaphoreSize(int semaphoreSize) &#123;</span><br><span class="line">        this.semaphoreSize = semaphoreSize;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¯´æ˜ï¼š</strong><br>æ­¤ç±»ç”³æ˜äº†Semaphoreä¿¡å·é‡ä»¥åŠå¯¹åº”çš„è®¸å¯å¤§å°ã€‚</p>
<h4 id="ä¸‰ã€åˆ›å»ºèµ„æºæ± ï¼Œå¹¶ç”¨ä¿¡å·é‡æ§åˆ¶"><a href="#ä¸‰ã€åˆ›å»ºèµ„æºæ± ï¼Œå¹¶ç”¨ä¿¡å·é‡æ§åˆ¶" class="headerlink" title="ä¸‰ã€åˆ›å»ºèµ„æºæ± ï¼Œå¹¶ç”¨ä¿¡å·é‡æ§åˆ¶"></a>ä¸‰ã€åˆ›å»ºèµ„æºæ± ï¼Œå¹¶ç”¨ä¿¡å·é‡æ§åˆ¶</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public class SemaphoreResourceFactory &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(SemaphoreResourceFactory.class);</span><br><span class="line"></span><br><span class="line">    private SemaphoreConstant semaphoreConstant;</span><br><span class="line"></span><br><span class="line">    private List&lt;EnvRoomDo&gt; envRooms;</span><br><span class="line"></span><br><span class="line">    private SemaphoreResourceFactory()&#123;</span><br><span class="line">        semaphoreConstant = new SemaphoreConstant();</span><br><span class="line">        envRooms = new ArrayList&lt;EnvRoomDo&gt;(semaphoreConstant.getSemaphoreSize());</span><br><span class="line">        for(int i = 0; i &lt; semaphoreConstant.getSemaphoreSize(); i++)&#123;</span><br><span class="line">            EnvRoomDo envRoomDo = new EnvRoomDo();</span><br><span class="line">            envRoomDo.setId(i);</span><br><span class="line">            envRoomDo.setName(&quot;æ•™å®¤_&quot; + i);</span><br><span class="line">            envRooms.add(envRoomDo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static SemaphoreResourceFactory getFactory()&#123;</span><br><span class="line">        return SemaphoreResourceFactoryHolder.factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æŠ¢å èµ„æº</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public RpcResult&lt;EnvRoomDo&gt; getRoom()&#123;</span><br><span class="line">        EnvRoomDo roomDo = null;</span><br><span class="line">        if(semaphoreConstant.getResouceRoomSemaphore().tryAcquire())&#123;</span><br><span class="line">            synchronized (envRooms) &#123;</span><br><span class="line">                if (envRooms != null &amp;&amp; envRooms.size() &gt; 0) &#123;</span><br><span class="line">                    roomDo = envRooms.remove(0);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if(roomDo == null)&#123;</span><br><span class="line">            return RpcResult.ofError(ErrorCode.BUSSINESS_ERROR.getCode(), &quot;æˆ¿é—´èµ„æºå·²è¢«å æ»¡&quot;);</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            return RpcResult.ofSuccess(roomDo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * é‡Šæ”¾èµ„æº</span><br><span class="line">     *</span><br><span class="line">     * @param roomDo</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public RpcResult&lt;Boolean&gt; releaseRoom(EnvRoomDo roomDo)&#123;</span><br><span class="line">        envRooms.add(roomDo);</span><br><span class="line">        semaphoreConstant.getResouceRoomSemaphore().release();</span><br><span class="line">        return RpcResult.ofSuccess(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class SemaphoreResourceFactoryHolder&#123;</span><br><span class="line">        private static SemaphoreResourceFactory factory = new SemaphoreResourceFactory();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¯´æ˜ï¼š</strong><br>1ã€SemaphoreResourceFactory()æ„é€ æ–¹æ³•ï¼Œå‘èµ„æºå˜é‡æ³¨å…¥å¯¹åº”çš„èµ„æºå¯¹è±¡ã€‚<br>2ã€getRoom()æ–¹æ³•ï¼Œå³è·å–èµ„æºçš„æ–¹æ³•ï¼Œå€ŸåŠ©äºä¸Šä¸€æ­¥åˆå§‹åŒ–çš„semaphoreConstant.getResouceRoomSemaphore()ä¿¡å·é‡çš„tryAcquire()æ–¹æ³•ï¼Œå°è¯•è·å¾—è®¸å¯ï¼Œå¦‚æœè·å¾—è®¸å¯ï¼Œåˆ™è¿”å›trueï¼Œè‹¥æœªè·å¾—è®¸å¯ï¼Œåˆ™ä¼šè¿”å›falseã€‚<br>3ã€releaseRoom()æ–¹æ³•ï¼Œå³é‡Šæ”¾èµ„æºçš„æ–¹æ³•ï¼Œå‘èµ„æºæ± ä¸­åŠ å…¥å·²ç»ä½¿ç”¨å®Œæˆçš„å¯¹è±¡ï¼ŒåŒæ—¶ä¿¡å·é‡å°†é‡Šæ”¾å¯¹åº”çš„è®¸å¯ã€‚<br>4ã€SemaphoreResourceFactoryHolderç±»ï¼Œå³å†…éƒ¨ç±»ï¼Œé€šè¿‡getFactory()æ–¹æ³•ï¼Œæ–¹ä¾¿å¤–éƒ¨ç±»å¯¹èµ„æºå·¥å‚çš„ä½¿ç”¨ã€‚</p>
<h4 id="å››ã€åˆ›å»ºè¯·æ±‚æ§åˆ¶å™¨ï¼Œå¯¹ç»“æœçš„å±•ç¤º"><a href="#å››ã€åˆ›å»ºè¯·æ±‚æ§åˆ¶å™¨ï¼Œå¯¹ç»“æœçš„å±•ç¤º" class="headerlink" title="å››ã€åˆ›å»ºè¯·æ±‚æ§åˆ¶å™¨ï¼Œå¯¹ç»“æœçš„å±•ç¤º"></a>å››ã€åˆ›å»ºè¯·æ±‚æ§åˆ¶å™¨ï¼Œå¯¹ç»“æœçš„å±•ç¤º</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/semaphore&quot;)</span><br><span class="line">public class SemaphoreController &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(SemaphoreController.class);</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/request/resource&quot;)</span><br><span class="line">    public RpcResult&lt;Boolean&gt; requestResource()&#123;</span><br><span class="line">        RpcResult&lt;EnvRoomDo&gt; roomDo = preempteRoom();</span><br><span class="line">        if(roomDo.getErrorCode() == 200) &#123;</span><br><span class="line">            logger.info(&quot;roomDo name = &#123;&#125;&quot;, roomDo.getValue().getName());</span><br><span class="line">            releaseRoom(roomDo.getValue());</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            logger.info(&quot;error msg = &#123;&#125;&quot;, roomDo.getErrorMsg());</span><br><span class="line">        &#125;</span><br><span class="line">        return RpcResult.ofSuccess(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æŠ¢å æˆ¿é—´</span><br><span class="line">     */</span><br><span class="line">    private RpcResult&lt;EnvRoomDo&gt; preempteRoom()&#123;</span><br><span class="line">        return SemaphoreResourceFactory.getFactory().getRoom();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * é‡Šæ”¾æˆ¿é—´</span><br><span class="line">     *</span><br><span class="line">     * @param roomDo</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private RpcResult&lt;Boolean&gt; releaseRoom(EnvRoomDo roomDo)&#123;</span><br><span class="line">        return SemaphoreResourceFactory.getFactory().releaseRoom(roomDo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¯´æ˜ï¼š</strong><br>Controlleræ¥å—å¯¹åº”çš„è¯·æ±‚ä¿¡æ¯ï¼Œçº¿ç¨‹é¦–å…ˆæŠ¢å èµ„æºï¼ŒæŠ¢å èµ„æºæˆåŠŸåï¼Œä¼šç«‹å³é‡Šæ”¾èµ„æºä¿¡æ¯ã€‚é¡¹ç›®çš„ç»“æœå±•ç¤ºä¸ºé‡Šæ”¾èµ„æºå’Œæœªé‡Šæ”¾èµ„æºä¸¤ç§æƒ…å†µ(å³requestResource()æ–¹æ³•æ˜¯å¦è°ƒç”¨releaseRoom()æ–¹æ³•)ï¼Œä»¥è¾¾åˆ°å±•ç¤ºSemaphoreå¯¹èµ„æºæ± çš„è°ƒæ§ã€‚</p>
<h4 id="äº”ã€ç»“æœ"><a href="#äº”ã€ç»“æœ" class="headerlink" title="äº”ã€ç»“æœ"></a>äº”ã€ç»“æœ</h4><p>å€ŸåŠ©abæµ‹è¯•è¿›è¡Œç»“æœæµ‹è¯•ï¼Œab -n 20 -c 3 <a href="http://localhost:8911/semaphore/request/resourceã€‚ç”±äºä¿¡å·é‡åˆå§‹åŒ–å¤§å°ä¸º10ï¼Œæ•…abæµ‹è¯•å…±å‘20ä¸ªè¯·æ±‚ï¼Œæ¯æ¬¡å¹¶å‘3ä¸ªè¯·æ±‚ã€‚" target="_blank" rel="noopener">http://localhost:8911/semaphore/request/resourceã€‚ç”±äºä¿¡å·é‡åˆå§‹åŒ–å¤§å°ä¸º10ï¼Œæ•…abæµ‹è¯•å…±å‘20ä¸ªè¯·æ±‚ï¼Œæ¯æ¬¡å¹¶å‘3ä¸ªè¯·æ±‚ã€‚</a></p>
<p>ä¸€ã€æœªé‡Šæ”¾èµ„æºå’ŒSemaphoreè®¸å¯çš„æƒ…å†µ</p>
<p><img src="http://obbgpy87z.bkt.clouddn.com/blog_semaphore_1.png" alt="æœª"></p>
<p>äºŒã€é‡Šæ”¾èµ„æºå’ŒSemaphoreè®¸å¯çš„æƒ…å†µ</p>
<p><img src="http://obbgpy87z.bkt.clouddn.com/blog_semaphore_2.png" alt="æœ‰"></p>
<h4 id="å…­ã€Semaphoreçš„ç›¸å…³æºç "><a href="#å…­ã€Semaphoreçš„ç›¸å…³æºç " class="headerlink" title="å…­ã€Semaphoreçš„ç›¸å…³æºç "></a>å…­ã€Semaphoreçš„ç›¸å…³æºç </h4><p><strong>tryAcquire()æ–¹æ³•ç›¸å…³çš„æºç ã€‚</strong></p>
<p>(1)ã€Semaphore.javaå†…çš„æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean tryAcquire() &#123;</span><br><span class="line">        return sync.nonfairTryAcquireShared(1) &gt;= 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private final Sync sync;</span><br><span class="line"></span><br><span class="line">abstract static class Sync extends AbstractQueuedSynchronizer&#123;</span><br><span class="line">	final int nonfairTryAcquireShared(int acquires) &#123;</span><br><span class="line">            for (;;) &#123;</span><br><span class="line">                int available = getState();</span><br><span class="line">                int remaining = available - acquires;</span><br><span class="line">                if (remaining &lt; 0 ||</span><br><span class="line">                    compareAndSetState(available, remaining))</span><br><span class="line">                    return remaining;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(2)ã€AbstractQueuedSynchronizer.javaå†…çš„æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private volatile int state;</span><br><span class="line"></span><br><span class="line">protected final int getState() &#123;</span><br><span class="line">        return state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ªäººç†è§£ï¼Œä¹‹æ‰€ä»¥Semaphoreèƒ½å¤Ÿåšåˆ°çº¿ç¨‹åŒæ­¥ï¼Œæºç ä¸­æœ‰å‡ ç‚¹éå¸¸é‡è¦ï¼š<br>1ã€AbstractQueuedSynchronizerç±»ä¸­çš„stateå˜é‡ç”¨volatileä¿®é¥°ï¼Œvolatileä¿è¯äº†å˜é‡çš„å†…å­˜å¯è§æ€§ï¼Œå¹¶é˜²æ­¢äº†æŒ‡ä»¤é‡æ’ï¼›<br>2ã€syncå˜é‡ç”¨finalä¿®é¥°ç¬¦ä¿®é¥°ï¼Œfinalä¿è¯äº†å˜é‡çš„ä¸å¯å˜æ€§ï¼Œå¹¶ç»§æ‰¿äº†AbstractQueuedSynchronizerç±»ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™æ˜¯æˆ‘å¯¹Semaphoreçš„ç†è§£ã€‚ç«¥é‹ä»¬å¦‚æœæœ‰æ›´å¥½çš„ç†è§£å¯ä»¥åŠ æˆ‘å¾®ä¿¡ï¼šwjd632479475ï¼Œå¸Œæœ›èƒ½å’Œä½ è®¤è¯†ã€‚å¤§å®¶ï¼Œä¸‹æ¬¡è§ã€‚</p>
<p>é™„<a href="https://github.com/JiongJiongGe/SemaphoreResourcePool" target="_blank" rel="noopener">GitHubé¡¹ç›®é“¾æ¥åœ°å€</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Semaphore/">Semaphore</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 äº‘å¼€
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>