<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>二个月后的重见，借助Shiro验证调用者的身份及权限 | 守得云开见月明 | 在IT海洋打滚的小🐳</title>

  
  <meta name="author" content="云开">
  

  
  <meta name="description" content="在IT海洋打滚的小🐳">
  

  
  
  <meta name="keywords" content="shiro">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="二个月后的重见，借助Shiro验证调用者的身份及权限"/>

  <meta property="og:site_name" content="守得云开见月明"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="守得云开见月明" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">守得云开见月明</a>
    </h1>
    <p class="site-description">在IT海洋打滚的小🐳</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/about">关于</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/tags">标签</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>二个月后的重见，借助Shiro验证调用者的身份及权限</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/06/09/yunkai_shiro/" rel="bookmark">
        <time class="entry-date published" datetime="2018-06-09T01:35:20.000Z">
          2018-06-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>在实际的软件开发中，出于安全性的考虑，往往需要对访问者访问的页面、接口做权限管理。如果从功能上来讲，安全性的定义就是访问者是以正确的方式请求资源，因此我把日常功能分为普通功能和特定功能(这两个名词仅仅是个人的想法😊)。所谓的普通功能，从普通两个字就能解读出大概的意思，就是允许所有用户操作，而特定功能，则需要用户具备某种特定身份才能操作。当然实现权限控制的方式有很多种，<br>例如：</p>
<ul>
<li>AOP+Filter实现</li>
<li>Spring Security</li>
<li>etc…</li>
</ul>
<p>说完了应用场景，也列举了几个实现权限控制的方式，不过相信大家从标题中就能知道本篇讲的应该是另外一种实现权限控制的方式：Shiro，那么接下来就让我介绍下在此篇中的主人公。</p>
<a id="more"></a>
<h2 id="Shiro介绍"><a href="#Shiro介绍" class="headerlink" title="Shiro介绍"></a>Shiro介绍</h2><p>Apache Shiro 是一个强大而灵活的开元安全框架，简单轻便地实现了用户认证、授权、企业会话管理和加密。当然，这介绍有些官网，说说我个人的理解吧，我个人觉得Shiro能够提供一套完整的权限控制方案，使得我在开发过程中，不需要借助其他的jar包或者API类。</p>
<h2 id="本篇项目对Shiro实现的思路"><a href="#本篇项目对Shiro实现的思路" class="headerlink" title="本篇项目对Shiro实现的思路"></a>本篇项目对Shiro实现的思路</h2><h4 id="先说一下我想借助Shiro来实现怎样的功能需求："><a href="#先说一下我想借助Shiro来实现怎样的功能需求：" class="headerlink" title="先说一下我想借助Shiro来实现怎样的功能需求："></a>先说一下我想借助Shiro来实现怎样的功能需求：</h4><h5 id="需求一："><a href="#需求一：" class="headerlink" title="需求一："></a>需求一：</h5><p>需要判断用户是否登录，如果未登录，提示登录。在此逻辑中，由于前后端分离的框架，如果用户第一次登录成功后，前端会在本地数据库中保存一个X_userToken值(保存着用户的信息)，如果此值安全，并且是Shiro中session认证信息过期的情况下，则会默认为登录(默认操作在服务端实现，稍后会重点提到)。</p>
<h5 id="需求二："><a href="#需求二：" class="headerlink" title="需求二："></a>需求二：</h5><p>在用户已经登录的情况下，判断用户是否以正确的方式请求资源，如果不是，则给出对应提示。</p>
<h5 id="解决思路："><a href="#解决思路：" class="headerlink" title="解决思路："></a>解决思路：</h5><p><img src="http://obbgpy87z.bkt.clouddn.com/blog_shiro.png" alt="解决思路"></p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h4 id="一、添加Shiro所需的maven依赖"><a href="#一、添加Shiro所需的maven依赖" class="headerlink" title="一、添加Shiro所需的maven依赖"></a>一、添加Shiro所需的maven依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	 &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h4 id="二、Shiro相关"><a href="#二、Shiro相关" class="headerlink" title="二、Shiro相关"></a>二、Shiro相关</h4><h5 id="ShiroConfig配置"><a href="#ShiroConfig配置" class="headerlink" title="ShiroConfig配置"></a>ShiroConfig配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class ShiroConfig &#123;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * ShiroFilterFactoryBean 实例</span><br><span class="line">	 * @param securityManager</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public ShiroFilterFactoryBean shirFilter(SecurityManager securityManager) &#123;</span><br><span class="line">		ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();</span><br><span class="line">		shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">		/**</span><br><span class="line">		 * 拦截器，配置不会被shiro拦截的路径</span><br><span class="line">		 */</span><br><span class="line">		Map&lt;String,String&gt; filterChainDefinitionMap = new LinkedHashMap&lt;String,String&gt;();</span><br><span class="line">		Map&lt;String, Filter&gt; filters = new LinkedHashMap&lt;&gt;();</span><br><span class="line">		filters.put(&quot;authc&quot;, getCustomAccessFilter());</span><br><span class="line">		filterChainDefinitionMap.put(&quot;/shiro/filer&quot;, &quot;anon&quot;);</span><br><span class="line">		filterChainDefinitionMap.put(&quot;/logout&quot;, &quot;logout&quot;);</span><br><span class="line">		filterChainDefinitionMap.put(&quot;/**&quot;, &quot;authc&quot;);</span><br><span class="line">		shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">		/**</span><br><span class="line">		 * 配置未验证成功跳转的路径</span><br><span class="line">		 */</span><br><span class="line">		shiroFilterFactoryBean.setLoginUrl(&quot;/login&quot;);</span><br><span class="line">		shiroFilterFactoryBean.setFilters(filters);</span><br><span class="line">		return shiroFilterFactoryBean;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 配置安全数据源，shiro从数据库中获取安全数据(用户、角色、权限)</span><br><span class="line">	 *</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public ShiroRealm shiroRealm()&#123;</span><br><span class="line">		ShiroRealm shiroRealm = new ShiroRealm();</span><br><span class="line">		return shiroRealm;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    /**</span><br><span class="line">	 * 自定义过滤器</span><br><span class="line">	 *</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public ShiroCustomAccessFilter getCustomAccessFilter()&#123;</span><br><span class="line">		return new ShiroCustomAccessFilter();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 配置securityManager,通过Realm获取相应的用户身份确认合法性</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public SecurityManager securityManager()&#123;</span><br><span class="line">		DefaultWebSecurityManager securityManager =  new DefaultWebSecurityManager();</span><br><span class="line">		securityManager.setRealm(shiroRealm());</span><br><span class="line">		return securityManager;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 开启shiro aop注解支持.</span><br><span class="line">	 * 使用代理方式;所以需要开启代码支持;</span><br><span class="line">	 * @param securityManager</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	@Bean</span><br><span class="line">	public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(SecurityManager securityManager)&#123;</span><br><span class="line">		AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = new AuthorizationAttributeSourceAdvisor();</span><br><span class="line">		authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span><br><span class="line">		return authorizationAttributeSourceAdvisor;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码说明：<br>1、ShiroFilterFactoryBean作为一个工厂Bean，将Shiro实例对象注入到Spring容器中，同时可以设置安全管理器(securityManager)、拦截器(filterChainDefinitionMap、filters)、配置未成功登录跳转信息等属性，这样Shiro就可以基于url的方式进行请求过滤处理。<br>2、shiroRealm()方法，配置安全数据源,在ShiroRealm类中，会验证用户是否认证且会获取到用户的权限，并将权限集放入Shiro中。<br>3、securityManager()方法，即配置安全管理器，以实施应用所需的安全策略，即实施ShiroRealm类中的策略。<br>4、getCustomAccessFilter()方法，自定义过滤器。<br>接下来会重点讲ShiroRealm类和ShiroCustomAccessFilter类</p>
<h5 id="ShiroCustomMatcher-自定义Matcher-密码匹配过程"><a href="#ShiroCustomMatcher-自定义Matcher-密码匹配过程" class="headerlink" title="ShiroCustomMatcher 自定义Matcher(密码匹配过程)"></a>ShiroCustomMatcher 自定义Matcher(密码匹配过程)</h5><p>因为验证用户是否合法是借助于X_userToken的方式，无需进行密码登录，故在此方案中，我采用的是Shiro免密登录的操作。(Shior在我的实际开发项目中X_userToken的值是通过第三方平台返回，如果是密码登录项目中，也可以生成对应的X_userToken)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public enum ShiroLoginType &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 1、需要密码验证登陆;2、无需密码验证登陆</span><br><span class="line">     */</span><br><span class="line">    PASSWORD(1),</span><br><span class="line">    NOPASSWORD(2);</span><br><span class="line"></span><br><span class="line">    private int code;</span><br><span class="line"></span><br><span class="line">    ShiroLoginType(int code) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getCode() &#123;</span><br><span class="line">        return code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCode(int code) &#123;</span><br><span class="line">        this.code = code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * shiro自定义用户密码token</span><br><span class="line">  */</span><br><span class="line">public class ShiroCustomToken extends UsernamePasswordToken &#123;</span><br><span class="line"></span><br><span class="line">    private ShiroLoginType type;   //是否需要密码登录类型</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public ShiroCustomToken(String userName, String password, ShiroLoginType type) &#123;</span><br><span class="line">        super(userName, password);</span><br><span class="line">        this.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public ShiroLoginType getType() &#123;</span><br><span class="line">        return type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setType(ShiroLoginType type) &#123;</span><br><span class="line">        this.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class ShiroCustomMatcher extends HashedCredentialsMatcher &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean doCredentialsMatch(AuthenticationToken token, AuthenticationInfo info) &#123;</span><br><span class="line">        ShiroCustomToken customToken = (ShiroCustomToken) token;</span><br><span class="line">        //如果设置无需密码验证，则直接返回true值</span><br><span class="line">        if(customToken.getType() == ShiroLoginType.NOPASSWORD)&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：<br>1、ShiroCustomToken继承了UsernamePasswordToken类，并增加type属性，表示是否需要密码登录<br>2、在ShiroCustomMatcher类中，通过AuthenticationToken类获取到ShiroCustomToken对象，如果对应的type类型为NOPASSWORD，则返回true表示免密登录。</p>
<h5 id="ShirlRealm类"><a href="#ShirlRealm类" class="headerlink" title="ShirlRealm类"></a>ShirlRealm类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * 授权权限验证</span><br><span class="line">  *</span><br><span class="line">  * @param principals</span><br><span class="line">  * @return</span><br><span class="line">  */</span><br><span class="line"> @Override</span><br><span class="line"> protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) &#123;</span><br><span class="line">     SimpleAuthorizationInfo authorizationInfo = new SimpleAuthorizationInfo();</span><br><span class="line">     try &#123;</span><br><span class="line">         UserDo userDo = (UserDo) principals.getPrimaryPrincipal();</span><br><span class="line">         //获取用户角色关系</span><br><span class="line">         List&lt;UserRoleDo&gt; userRoleDos = userRoleService.getByUserId(userDo.getId());</span><br><span class="line">         List&lt;Integer&gt; roleIds = new ArrayList&lt;Integer&gt;();</span><br><span class="line">         if (!CollectionUtils.isEmpty(userRoleDos)) &#123;</span><br><span class="line">             for (UserRoleDo userRoleDo : userRoleDos) &#123;</span><br><span class="line">                 roleIds.add(userRoleDo.getRoleId());</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         //获取用户角色信息</span><br><span class="line">         List&lt;RoleDo&gt; roleDos = roleService.findList(roleIds);</span><br><span class="line">         if (!CollectionUtils.isEmpty(roleDos)) &#123;</span><br><span class="line">             for (RoleDo roleDo : roleDos) &#123;</span><br><span class="line">                 authorizationInfo.addRole(roleDo.getRole());</span><br><span class="line">                 //获取角色权限</span><br><span class="line">                 List&lt;RolePermissionDo&gt; rolePermissionDos = rolePermissionService.findByRoleId(roleDo.getId());</span><br><span class="line">                 List&lt;Integer&gt; rpIds = new ArrayList&lt;Integer&gt;();</span><br><span class="line">                 if (!CollectionUtils.isEmpty(rolePermissionDos)) &#123;</span><br><span class="line">                     for (RolePermissionDo rolePermissionDo : rolePermissionDos) &#123;</span><br><span class="line">                         rpIds.add(rolePermissionDo.getPermissId());</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 List&lt;PermissionDo&gt; permissionDos = permissionService.findList(rpIds);</span><br><span class="line">                 if (!CollectionUtils.isEmpty(permissionDos)) &#123;</span><br><span class="line">                     for (PermissionDo permissionDo : permissionDos) &#123;</span><br><span class="line">                         authorizationInfo.addStringPermission(permissionDo.getPermissionMessage());</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;catch (Exception e)&#123;</span><br><span class="line">         logger.error(&quot;doGetAuthorizationInfo error = &#123;&#125;&quot;, e);</span><br><span class="line">     &#125;</span><br><span class="line">     return authorizationInfo;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * 验证用户是否认证</span><br><span class="line">  * @param token</span><br><span class="line">  * @return</span><br><span class="line">  * @throws AuthenticationException</span><br><span class="line">  */</span><br><span class="line"> @Override</span><br><span class="line"> protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token)</span><br><span class="line">         throws AuthenticationException &#123;</span><br><span class="line">     //获取传入的用户ID.</span><br><span class="line">     String userID = (String)token.getPrincipal();</span><br><span class="line">     //根据用户ID获取对象，若存在。则验证成功</span><br><span class="line">     UserDo userDo = userService.getByID(userID);</span><br><span class="line">     if(userDo == null)&#123;</span><br><span class="line">         return null;</span><br><span class="line">     &#125;</span><br><span class="line">     SimpleAuthenticationInfo authenticationInfo = new SimpleAuthenticationInfo(userDo, &quot;&quot;, getName());</span><br><span class="line">     return authenticationInfo;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>代码说明：<br>1、doGetAuthorizationInfo()验证用户是否具备请求该资源的权限。<br>2、doGetAuthenticationInfo()方法则验证用户是否认证。</p>
<h5 id="ShiroCustomAccessFilter自定义过滤器"><a href="#ShiroCustomAccessFilter自定义过滤器" class="headerlink" title="ShiroCustomAccessFilter自定义过滤器"></a>ShiroCustomAccessFilter自定义过滤器</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @Intro: 自定义判断权限filter</span><br><span class="line"> * @Author: WangJiongDa(yunkai)</span><br><span class="line"> * @Date: 2018/6/1</span><br><span class="line"> * @Time: 下午4:55</span><br><span class="line"> */</span><br><span class="line">public class ShiroCustomAccessFilter extends AccessControlFilter &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(ShiroCustomAccessFilter.class);</span><br><span class="line"></span><br><span class="line">    private String loginUrl = &quot;/login&quot;;</span><br><span class="line"></span><br><span class="line">    private static final String noPermissUrl = &quot;/no/permission&quot;;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private PermissionService permissionService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isAccessAllowed(ServletRequest servletRequest, ServletResponse servletResponse, Object o) throws Exception &#123;</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        if(loginUrl.equals(getPathWithinApplication(servletRequest)) || (noPermissUrl.equals(getPathWithinApplication(servletRequest))) || checkPermission(servletRequest, subject))&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean onAccessDenied(ServletRequest servletRequest, ServletResponse servletResponse) throws Exception &#123;</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        HttpServletRequest httpRequest = WebUtils.toHttp(servletRequest);</span><br><span class="line">        if(!subject.isAuthenticated() &amp;&amp; !pathsMatch(loginUrl, servletRequest))&#123;</span><br><span class="line">            Session session = subject.getSession();</span><br><span class="line">            Map&lt;String, Object&gt; reqParams = new HashMap&lt;String, Object&gt;();</span><br><span class="line">            Enumeration em = httpRequest.getParameterNames();</span><br><span class="line">            //获取post请求body中请求的参数</span><br><span class="line">            while (em.hasMoreElements()) &#123;</span><br><span class="line">                String name = (String) em.nextElement();</span><br><span class="line">                String value = httpRequest.getParameter(name);</span><br><span class="line">                reqParams.put(name, value);</span><br><span class="line">            &#125;</span><br><span class="line">            SavedRequestBean savedRequestBean = new SavedRequestBean(httpRequest, reqParams);</span><br><span class="line">            session.setAttribute(&quot;savedRequestBean&quot;, savedRequestBean);</span><br><span class="line">            saveRequestAndRedirectToLogin(servletRequest, servletResponse);</span><br><span class="line">        &#125; else&#123;</span><br><span class="line"></span><br><span class="line">            if(!checkPermission(servletRequest, subject))&#123;</span><br><span class="line">                WebUtils.issueRedirect(servletRequest, servletResponse, noPermissUrl);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 验证用户权限</span><br><span class="line">     *</span><br><span class="line">     * @param servletRequest</span><br><span class="line">     * @param subject</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private boolean checkPermission(ServletRequest servletRequest, Subject subject)&#123;</span><br><span class="line">        HttpServletRequest request = WebUtils.toHttp(servletRequest);</span><br><span class="line">        String actionUrl = WebUtils.getRequestUri(request);</span><br><span class="line">        PermissionDo permission = permissionService.getByUrl(actionUrl);</span><br><span class="line">        if(subject.isPermitted(permission.getPermissionMessage()))&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码说明：<br>ShiroCustomAccessFilter继承了AccessControlFilter抽象类，并重写了isAccessAllowed()和onAccessDenied()方法。<br>1、isAccessAllowed()方法内会判断是否允许访问，true表示允许访问，false则不允许访问。在实现中，当请求路径为/login、/no/permission和用户拥有访问此链接的权限时，返回true，否则返回false。<br>2、onAccessDenied()方法则会当isAccessAllowed()放回false时，做自定义处理。在实现中，当用户未登录时，会调用saveRequestAndRedirectToLogin()方法，跳转到/login请求中(之后会讲到login的处理)，当用户权限不足时，会跳转到/no/permission中，提示权限不足。其他则返回false，不做任何处理。同时，会在此方法中，记录用户在未登录的情况下请求的链接和参数。<br>3、checkPermission()方法则是私有方法，判断用户是否有访问此请求的权限。<br>4、subject.isPermitted()方法在验证权限时，会调用ShiroRelam类中的doGetAuthorizationInfo()方法去验证权限。</p>
<h5 id="BaseController、LoginController、PermissionController"><a href="#BaseController、LoginController、PermissionController" class="headerlink" title="BaseController、LoginController、PermissionController"></a>BaseController、LoginController、PermissionController</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public class BaseController &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(BaseController.class);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取request body中的参数，如果通过shiro重登录，则从上一个请求中获取</span><br><span class="line">     *</span><br><span class="line">     * @param request</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    protected Map&lt;String, Object&gt; getRequestParams(HttpServletRequest request)&#123;</span><br><span class="line">        Map&lt;String, Object&gt; reqParams = new HashMap&lt;String, Object&gt;();</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        Session session = subject.getSession();</span><br><span class="line">        SavedRequestBean savedRequestBean = (SavedRequestBean) session.getAttribute(&quot;savedRequestBean&quot;);</span><br><span class="line">        if(savedRequestBean != null)&#123;</span><br><span class="line">            reqParams = savedRequestBean.getParams();</span><br><span class="line">            session.removeAttribute(&quot;savedRequestBean&quot;);</span><br><span class="line">        &#125; else&#123;</span><br><span class="line">            Enumeration em = request.getParameterNames();</span><br><span class="line">            //获取post请求body中请求的参数</span><br><span class="line">            while (em.hasMoreElements()) &#123;</span><br><span class="line">                String name = (String) em.nextElement();</span><br><span class="line">                String value = request.getParameter(name);</span><br><span class="line">                reqParams.put(name, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return reqParams;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取登录用户ID</span><br><span class="line">     *</span><br><span class="line">     * @param request</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    protected Integer getUserId(HttpServletRequest request)&#123;</span><br><span class="line">        Integer userID = (Integer) request.getAttribute(&quot;userID&quot;);</span><br><span class="line">        return userID;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码说明：<br>getRequestParams()方法会获取用户请求的参数，同时在此方法中会判断，请求是否走了以下的流程：请求A(未登录)-&gt;/login-&gt;请求A中，如果是这样，会从subject的session中获取之前在onAccessDenied()方法中保存的参数信息。<br>getUserId()方法是从拦截器中获取到request中的userID信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class LoginController extends BaseController&#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(LoginController.class);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 通过使用用户的token，进行shiro登陆</span><br><span class="line">     *</span><br><span class="line">     * @param servletRequest</span><br><span class="line">     * @param servletResponse</span><br><span class="line">     * @return</span><br><span class="line">     * @throws IOException</span><br><span class="line">     */</span><br><span class="line">    @RequestMapping(&quot;/login&quot;)</span><br><span class="line">    public RpcResult&lt;Boolean&gt; login(ServletRequest servletRequest, ServletResponse servletResponse) throws IOException &#123;</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        SavedRequest sr = WebUtils.getSavedRequest(servletRequest);</span><br><span class="line">        HttpServletRequest request = WebUtils.toHttp(servletRequest);</span><br><span class="line">        String X_userToken = request.getHeader(&quot;X_userToken&quot;);</span><br><span class="line">        Integer userID = ParseTokenUtil.parse(X_userToken);</span><br><span class="line">        if(!subject.isAuthenticated()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                ShiroCustomToken token = new ShiroCustomToken(userID + &quot;&quot;, &quot;&quot;, ShiroLoginType.NOPASSWORD);</span><br><span class="line">                subject.login(token);</span><br><span class="line">            &#125;catch (Exception e)&#123;</span><br><span class="line">                logger.error(&quot;error = &#123;&#125;&quot;, e.getMessage());</span><br><span class="line">                return RpcResult.ofError(ErrorCode.BIZ_ERROR.getCode(), ErrorCode.BIZ_ERROR.getMsg(&quot;shiro验证失败&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        WebUtils.issueRedirect(servletRequest, servletResponse, sr.getRequestUrl());</span><br><span class="line">        return RpcResult.ofSuccess(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码说明：<br>之前有提到，如果X_userToken安全，并且是Shiro中session认证信息过期的情况下，服务端会做Shiro登录处理，调用subject.login(token)方法，使用自定义ShiroCustomToken免登token，帮助用户无感知的完成登录，无需用户重新输入用户名和密码，提高用户体验。当然，如果用户验证失败，则会在catch中捕获到异常，返回验证失败的信息，信息返回给前端，前端同学可以根据返回的信息做相关的判断逻辑。<br>subject.login()方法执行后，会进入到ShiroRealm中的doGetAuthenticationInfo()方法，在doGetAuthenticationInfo()方法中，如果userID能获取到user对象，则默认登录成功。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class PermissionController extends BaseController&#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 权限不足</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @RequestMapping(&quot;/no/permission&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public RpcResult&lt;String&gt; noPermission()&#123;</span><br><span class="line">        return RpcResult.ofError(ErrorCode.BIZ_ERROR.getCode(), ErrorCode.BIZ_ERROR.getMsg(&quot;权限不足&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码说明：<br>进入此请求则表示用户访问的请求没有对应的权限，从而跳转到此方法中。</p>
<h4 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h4><p>1、项目的元素有些丰富，在本篇中不能一一说明，有兴趣的童鞋可以去gitHub上下载项目查看到所有的实现。<br>2、当然本项目还存着一些值得优化的地方，例如doGetAuthorizationInfo()方法中获取权限的方式，可以将权限通过Redis缓存起来，而无需每次从DB中获取，提高执行效率。如果借助Redis，当用户权限更新时，必须要立即更新Redis内的值信息。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Shiro框架的安全认证在实际的开发中应用也比较普遍，小🐳在此篇中只是使用了基本的方法实现自己开发中所需的功能，希望能给大家一个入门的指引，当然如果你用到了Shiro的其他功能或者比我更好地实现，可以给我一些建议哦。本人微信：wjd632479475，希望能和你认识。大家，下次见。</p>
<p>附<a href="https://github.com/JiongJiongGe/SpringBootShiro" target="_blank" rel="noopener">GitHub项目链接地址</a></p>
<p>LINKS：<br><a href="https://blog.csdn.net/xieliaowa9231/article/details/78996451" target="_blank" rel="noopener">SpringBoot整合Shiro自定义过滤器</a><br><a href="http://blog.51cto.com/wyait/2107423" target="_blank" rel="noopener">Shiro AccessControlFilter方法介绍</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/shiro/">shiro</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 云开
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>